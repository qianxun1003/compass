<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿åˆ†æ | JI-æ—¥æœ¬ç•™å­¦ãƒŠãƒ“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-cream: #fdfcf8;
            --bg-warm: #fefdf9;
            --border-slate: #e8e4dc;
            --text-primary: #4a4540;
            --text-secondary: #6b6560;
            --accent: #8b7355;
            --warm-yellow: #e8dcc8;
            --warm-beige: #d4c4a8;
            --cream-highlight: #f5f0e6;
            --chart-1: #a8987a;
            --chart-2: #8b7355;
            --chart-3: #6b5b45;
            --chart-4: #0ea5e9;
            --chart-5: #22c55e;
            --chart-6: #c9a227;
            --chart-7: #d4b896;
        }
        * {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0; box-sizing: border-box;
            font-weight: 400;
            letter-spacing: 0.04em;
        }
        body {
            background: var(--bg-cream);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: 15px;
        }
        h1, h2, h3, h4, .report-title, .accordion-trigger > div > span {
            font-weight: 500;
        }
        .report-paper .report-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.65;
            margin-bottom: 16px;
        }
        .report-paper .report-note {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 12px;
            padding: 10px 14px;
            background: var(--warm-yellow);
            border-radius: 10px;
            border-left: 3px solid var(--chart-6);
        }
        .report-paper .score-table-wrap {
            margin-top: 16px;
            overflow-x: auto;
        }
        .report-paper table.score-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            color: var(--text-primary);
        }
        .report-paper table.score-table th,
        .report-paper table.score-table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-slate);
        }
        .report-paper table.score-table th {
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--warm-yellow);
        }
        .report-paper table.score-table tr:hover td { background: rgba(248, 250, 252, 0.5); }
        .glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-slate);
            box-shadow: 0 2px 16px rgba(100, 116, 139, 0.06);
        }
        .card {
            background: linear-gradient(145deg, rgba(255,255,255,0.85) 0%, var(--cream-highlight) 100%);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-slate);
            box-shadow: 0 2px 16px rgba(139, 115, 85, 0.06);
            border-radius: 14px;
        }
        .accordion-trigger {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-slate);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .accordion-trigger:hover {
            background: rgba(255, 253, 248, 0.9);
            border-color: var(--warm-beige);
        }
        .accordion-trigger .trigger-icon {
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }
        .accordion-trigger.open .trigger-icon { transform: translateY(-50%) rotate(180deg); }
        .accordion-trigger .trigger-desc { font-size: 0.75rem; color: var(--text-secondary); padding-right: 2rem; }
        .accordion-trigger-wrapper { position: relative; width: 100%; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .accordion-content-inner {
            padding: 1.5rem 1.75rem;
            border: 1px solid var(--border-slate);
            border-top: none;
            border-radius: 0 0 14px 14px;
            margin-top: -1px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
        }
        .chart-container { position: relative; height: 300px; min-height: 240px; padding: 12px 8px 20px; }
        @media (max-width: 768px) { .chart-container { height: 260px; min-height: 220px; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .chart-card { animation: fadeIn 0.45s ease-out forwards; }
        @keyframes revealUp {
            from { opacity: 0; transform: translateY(32px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .results-reveal { animation: revealUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .search-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-slate);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--warm-beige);
            box-shadow: 0 0 0 2px rgba(212, 196, 168, 0.35);
        }
        .btn-search {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            background: linear-gradient(180deg, var(--chart-2) 0%, var(--chart-3) 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 115, 85, 0.3);
        }
        .report-circle {
            width: 168px;
            height: 88px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: linear-gradient(145deg, var(--cream-highlight) 0%, rgba(255,255,255,0.85) 100%);
            border: 1px solid var(--warm-beige);
            box-shadow: 0 2px 12px rgba(139, 115, 85, 0.1);
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }
        .report-circle:hover {
            background: linear-gradient(145deg, #fff9ef 0%, var(--cream-highlight) 100%);
            border-color: var(--chart-6);
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(201, 162, 39, 0.15);
        }
        .report-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(253, 252, 248, 0.72);
            backdrop-filter: blur(20px) saturate(110%);
            -webkit-backdrop-filter: blur(20px) saturate(110%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, visibility 0.35s ease;
        }
        .report-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .report-overlay.open .report-paper {
            opacity: 1;
            transform: scale(1);
        }
        .report-paper {
            position: relative;
            max-width: 92vw;
            width: 660px;
            max-height: 88vh;
            overflow: auto;
            background: linear-gradient(180deg, #fffefb 0%, var(--bg-warm) 100%);
            border-radius: 18px;
            box-shadow: 0 24px 48px rgba(74, 69, 64, 0.1), 0 0 0 1px rgba(212, 196, 168, 0.25);
            padding: 32px 40px;
            opacity: 0;
            transform: scale(0.94);
            transition: opacity 0.35s cubic-bezier(0.22, 1, 0.36, 1), transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .report-paper .report-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            padding-right: 36px;
        }
        .report-paper .report-table-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 20px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--chart-6);
        }
        .report-paper .report-table-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }
        .report-paper .report-chart-wrap {
            position: relative;
            height: 280px;
            min-height: 220px;
        }
        .report-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }
        .report-close:hover {
            background: var(--warm-yellow);
            color: var(--text-primary);
        }
        .report-paper .dept-select-wrap { margin-bottom: 16px; }
        .report-paper select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-slate);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-primary);
            background: #fff;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(226, 232, 240, 0.6); border-radius: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--warm-beige); border-radius: 8px; }
        .page-title-fluid { font-size: clamp(0.95rem, 2.5vw + 0.5rem, 1.25rem); }
        .page-body-fluid { font-size: clamp(0.8125rem, 1.5vw + 0.4rem, 0.875rem); }
        @media (max-width: 768px) {
            .nav-inner-analytics { flex-wrap: wrap; gap: 0.5rem; }
            main { padding-left: 1rem !important; padding-right: 1rem !important; }
        }
    </style>
</head>
<body>
    <script src="js/auth.js"></script><script>Auth.requireAuth();</script>
    <nav class="sticky top-0 z-50 glass border-b border-slate-200 rounded-none">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex items-center gap-2 sm:gap-3 nav-inner-analytics">
                <a href="index.html" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 hover:text-slate-700 transition-all flex-shrink-0" title="æˆ»ã‚‹">
                    <i class="fas fa-arrow-left text-sm sm:text-base"></i>
                </a>
                <div class="min-w-0">
                    <h1 class="page-title-fluid font-medium truncate" style="color: var(--text-primary)">ãƒ‡ãƒ¼ã‚¿åˆ†æ</h1>
                    <p class="page-body-fluid hidden sm:block" style="color: var(--text-secondary)">Analytics</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- å ±è¡¨å±•é–‹ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç£¨ç ‚ç»ç’ƒ + æ¸…æ™°å ±è¡¨ç´™ï¼‰ -->
    <div id="report-overlay" class="report-overlay">
        <div class="report-paper">
            <button type="button" class="report-close" id="report-close" aria-label="é–‰ã˜ã‚‹"><i class="fas fa-times"></i></button>
            <h3 class="report-title" id="report-modal-title"></h3>
            <p class="report-desc hidden" id="report-desc"></p>
            <p class="report-note hidden" id="report-note"></p>
            <div id="report-dept-wrap" class="dept-select-wrap hidden">
                <label class="block text-sm mb-2" style="color: var(--text-secondary)">é€‰æ‹©å­¦éƒ¨ï¼ˆæŸ¥çœ‹è¯¥å­¦éƒ¨å„ç§‘ç›®åˆ†æ•°ï¼‰</label>
                <select id="report-dept-select"></select>
            </div>
            <div id="report-subject-wrap" class="dept-select-wrap hidden">
                <label class="block text-sm mb-2" style="color: var(--text-secondary)">é€‰æ‹©ç§‘ç›®ï¼ˆåŒä¸€ç§‘ç›®ä¸‹å„å­¦éƒ¨åˆ†æ•°å¯¹æ¯”ï¼‰</label>
                <select id="report-subject-select"></select>
            </div>
            <div class="report-chart-wrap">
                <canvas id="report-chart-canvas"></canvas>
            </div>
            <div id="report-score-table-wrap" class="score-table-wrap hidden"></div>
        </div>
    </div>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 pb-20">
        <!-- åˆæ ¼å®Ÿç¸¾ï¼šæ¤œç´¢ â†’ ç¢ºèªå¾Œã«ã‚µãƒ¼ã‚¯ãƒ«è¡¨ç¤ºã€ã‚¯ãƒªãƒƒã‚¯ã§å ±è¡¨å±•é–‹ -->
        <section id="admission-section" class="mb-12">
            <div class="card p-6 sm:p-8 mb-6">
                <h2 class="text-2xl sm:text-3xl mb-1" style="color: var(--text-primary)">åˆæ ¼å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</h2>
                <p class="text-sm mb-6" style="color: var(--text-secondary)">å¤§å­¦åã‚’å…¥åŠ›ã—ã€æ¤œç´¢ã‚’æŠ¼ã™ã¨ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="university-search" class="search-input flex-1" placeholder="å¤§å­¦åï¼ˆä¾‹ï¼šæ±äº¬å¤§å­¦ã€å°‚ä¿®å¤§å­¦ï¼‰" autocomplete="off">
                    <button type="button" id="search-btn" class="btn-search">æ¤œç´¢</button>
                </div>
            </div>

            <div id="admission-results" class="hidden results-reveal">
                <p class="text-sm mb-4" style="color: var(--text-secondary)"><span id="selected-university-name"></span> ã®ãƒ¬ãƒãƒ¼ãƒˆ</p>
                <div class="flex flex-wrap gap-6 justify-start">
                    <button type="button" class="report-circle" data-report="compare" title="åŒä¸€ç§‘ç›®ä¸åŒå­¦éƒ¨çš„åˆ†æ•°è¦æ±‚">åŒä¸€ç§‘ç›®<br>ä¸åŒå­¦éƒ¨åˆ†æ•°</button>
                    <button type="button" class="report-circle" data-report="score" title="åŒä¸€å­¦éƒ¨çš„ä¸åŒç§‘ç›®åˆ†æ•°è¦æ±‚">åŒä¸€å­¦éƒ¨<br>ä¸åŒç§‘ç›®åˆ†æ•°</button>
                </div>
            </div>
            <div id="admission-empty" class="card p-12 text-center" style="color: var(--text-secondary)">
                <i class="fas fa-university text-4xl mb-4 opacity-50"></i>
                <p class="font-medium">å¤§å­¦åã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢ã€ã‚’æŠ¼ã™ã¨ã€ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </section>

        <!-- å­¦æ ¡ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ï¼ˆè¾…åŠ©ï¼‰ -->
        <div class="mb-8">
            <h2 class="text-2xl sm:text-3xl mb-1" style="color: var(--text-primary)">å­¦æ ¡ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</h2>
            <p class="text-sm" style="color: var(--text-secondary)">å­¦æ ¡ç·è¦§ã«åŸºã¥ãç•™å­¦ãƒˆãƒ¬ãƒ³ãƒ‰</p>
        </div>

        <div id="loading" class="text-center py-16 opacity-70">
            <i class="fas fa-spinner fa-spin text-3xl mb-3" style="color: var(--text-secondary)"></i>
            <p class="text-sm" style="color: var(--text-secondary)">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</p>
        </div>

        <div id="accordions" class="space-y-3 hidden">
            <div class="accordion-item">
                <button type="button" class="accordion-trigger" data-target="panel-1" aria-expanded="false">
                    <div class="accordion-trigger-wrapper">
                        <span>ğŸ“š å­¦ç§‘ã¨å‡ºé¡˜è³‡æ ¼</span>
                        <p class="trigger-desc mt-1">æ–‡ç†ãƒ»JLPTãƒ»è‹±èªãªã©ã®åŸºæº–</p>
                        <i class="fas fa-chevron-down text-sm trigger-icon"></i>
                    </div>
                </button>
                <div class="accordion-content" id="panel-1">
                    <div class="accordion-content-inner space-y-6">
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">æ–‡ç†æ¯”ç‡</h4>
                            <div class="chart-container"><canvas id="chart-bunri"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">è‹±èªè¦ä»¶</h4>
                            <div class="chart-container"><canvas id="chart-english"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">JLPTè¦ä»¶</h4>
                            <div class="chart-container"><canvas id="chart-jlpt"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <button type="button" class="accordion-trigger" data-target="panel-2" aria-expanded="false">
                    <div class="accordion-trigger-wrapper">
                        <span>ğŸ“ é¸æŠœæ–¹æ³•</span>
                        <p class="trigger-desc mt-1">æ ¡å†…è€ƒã®å½¢å¼ã‚„ä½µé¡˜å¯å¦</p>
                        <i class="fas fa-chevron-down text-sm trigger-icon"></i>
                    </div>
                </button>
                <div class="accordion-content" id="panel-2">
                    <div class="accordion-content-inner space-y-6">
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">æ ¡å†…è€ƒå½¢å¼ã®å‰²åˆ</h4>
                            <div class="chart-container"><canvas id="chart-exam-format"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">ä½µé¡˜å¯å¦</h4>
                            <div class="chart-container"><canvas id="chart-combined"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <button type="button" class="accordion-trigger" data-target="panel-3" aria-expanded="false">
                    <div class="accordion-trigger-wrapper">
                        <span>ğŸ“ ç«‹åœ°ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
                        <p class="trigger-desc mt-1">ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®å ´æ‰€ã‚„å‡ºé¡˜æ™‚æœŸ</p>
                        <i class="fas fa-chevron-down text-sm trigger-icon"></i>
                    </div>
                </button>
                <div class="accordion-content" id="panel-3">
                    <div class="accordion-content-inner space-y-6">
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">ä½ç½®åˆ†å¸ƒ</h4>
                            <div class="chart-container"><canvas id="chart-region"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">å‡ºé¡˜æœŸæ•°åˆ†å¸ƒ</h4>
                            <div class="chart-container"><canvas id="chart-period"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">å‡ºé¡˜ç· åˆ‡æœˆåˆ†å¸ƒ</h4>
                            <div class="chart-container"><canvas id="chart-deadline"></canvas></div>
                        </div>
                        <div class="chart-card card p-5 sm:p-6">
                            <h4 class="text-sm font-medium mb-4" style="color: var(--text-primary)">EJUã‚¹ã‚³ã‚¢äº’æ›æ€§</h4>
                            <div class="chart-container"><canvas id="chart-eju"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const PALETTE = ['#a8987a', '#8b7355', '#6b5b45', '#0ea5e9', '#22c55e', '#c9a227', '#d4b896', '#b8a078'];
        const defaultFont = { family: "'Noto Sans JP', sans-serif", size: 12, weight: 400, color: '#4a4540' };
        const isMobile = () => window.innerWidth <= 768;

        let admissionModel = { bunka: {}, rika: {} };
        let selectedUniversityName = '';
        let reportModalChart = null;

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            if (!lines.length) return [];
            const parseRow = (line) => {
                const out = [];
                let cur = '', inQ = false;
                for (let i = 0; i < line.length; i++) {
                    const c = line[i];
                    if (c === '"') inQ = !inQ;
                    else if (c === ',' && !inQ) { out.push(cur.trim()); cur = ''; }
                    else cur += c;
                }
                out.push(cur.trim());
                return out.map(s => s.replace(/^"|"$/g, ''));
            };
            const header = parseRow(lines[0]);
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const vals = parseRow(lines[i]);
                const row = {};
                header.forEach((h, idx) => { row[h] = vals[idx] || ''; });
                rows.push(row);
            }
            return rows;
        }

        function countBy(arr, key, normalizer) {
            const map = {};
            arr.forEach(r => {
                let v = r[key];
                if (v === undefined || v === null || String(v).trim() === '') v = 'æœªå¡«å†™';
                const k = normalizer ? normalizer(String(v)) : String(v).trim();
                map[k] = (map[k] || 0) + 1;
            });
            return map;
        }

        function extractRegion(loc) {
            if (!loc) return 'æœªå¡«å†™';
            const m = loc.match(/^([^\s]+[éƒ½é“åºœçœŒ])/);
            return m ? m[1] : loc.split(/[å¸‚ç”ºæ‘]/)[0] || loc;
        }

        function extractExamFormats(str) {
            if (!str) return ['æœªå¡«å†™'];
            return str.split(/[,ï¼Œã€]/).map(s => s.trim()).filter(Boolean);
        }

        function extractEjuLabel(str) {
            if (!str) return 'æœªå¡«å†™';
            const s = String(str).toLowerCase();
            if (/å½“å¹´|6æœˆ|11æœˆ|éƒ½å¯|ä¸¡æ–¹/i.test(s)) return 'å½“å¹´6æœˆ/11æœˆå‡å¯';
            if (/6æœˆ|ç¬¬1å›/i.test(s)) return 'ä»…6æœˆ';
            if (/11æœˆ|ç¬¬2å›/i.test(s)) return 'ä»…11æœˆ';
            if (/2å¹´|ä¸¤å¹´/i.test(s)) return '2å¹´å†…æœ‰æ•ˆ';
            return str.length > 12 ? str.slice(0, 12) + 'â€¦' : str;
        }

        function extractPeriod(str) {
            if (!str) return 'æœªå¡«å†™';
            const s = String(str);
            if (/å‰æœŸ|â… |1æœŸ|A|ç¬¬1/i.test(s)) return 'å‰æœŸ';
            if (/åæœŸ|â…¡|2æœŸ|B|ç¬¬2/i.test(s)) return 'åæœŸ';
            if (/åªæœ‰ä¸€æœŸ|ä¸€æœŸã®ã¿|å•ä¸€/i.test(s)) return 'ä»…ä¸€æœŸ';
            return s.length > 8 ? s.slice(0, 8) + 'â€¦' : s;
        }

        function createChart(id, config) {
            const ctx = document.getElementById(id);
            if (!ctx) return null;
            const font = { ...defaultFont, size: isMobile() ? 11 : 12 };
            return new Chart(ctx.getContext('2d'), {
                ...config,
                options: {
                    ...config.options,
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 8, right: 12, bottom: 20, left: 12 } },
                    plugins: {
                        ...config.options?.plugins,
                        legend: {
                            position: 'bottom',
                            labels: { font: font, color: font.color, padding: 16, boxWidth: 14 }
                        },
                        tooltip: { enabled: true, bodyFont: font, titleFont: font, padding: 10 }
                    },
                    scales: config.options?.scales ? {
                        ...config.options.scales,
                        x: { ...config.options.scales?.x, ticks: { ...config.options.scales?.x?.ticks, font: font, color: font.color, maxRotation: 45 } },
                        y: { ...config.options.scales?.y, ticks: { ...config.options.scales?.y?.ticks, font: font, color: font.color } }
                    } : undefined
                }
            });
        }

        function getMergedUniversityData(name) {
            const fromB = admissionModel.bunka[name] || {};
            const fromR = admissionModel.rika[name] || {};
            return { ...fromB, ...fromR };
        }

        function searchUniversities(keyword) {
            const k = String(keyword).trim().toLowerCase();
            if (!k) return [];
            const set = new Set();
            Object.keys(admissionModel.bunka || {}).forEach(n => { if (n.toLowerCase().includes(k)) set.add(n); });
            Object.keys(admissionModel.rika || {}).forEach(n => { if (n.toLowerCase().includes(k)) set.add(n); });
            return Array.from(set);
        }

        function createChartInModal(config) {
            const canvas = document.getElementById('report-chart-canvas');
            if (!canvas) return null;
            if (reportModalChart) { reportModalChart.destroy(); reportModalChart = null; }
            const font = { ...defaultFont, size: isMobile() ? 11 : 12 };
            return new Chart(canvas.getContext('2d'), {
                ...config,
                options: {
                    ...config.options,
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 8, right: 12, bottom: 20, left: 12 } },
                    plugins: {
                        ...config.options?.plugins,
                        legend: { position: 'bottom', labels: { font: font, color: font.color, padding: 12, boxWidth: 14 } },
                        tooltip: { enabled: true, bodyFont: font, titleFont: font }
                    },
                    scales: config.options?.scales ? {
                        ...config.options.scales,
                        x: { ...config.options.scales?.x, ticks: { ...config.options.scales?.x?.ticks, font: font, color: font.color, maxRotation: 45 } },
                        y: { ...config.options.scales?.y, ticks: { ...config.options.scales?.y?.ticks, font: font, color: font.color } }
                    } : undefined
                }
            });
        }

        function openReport(reportType) {
            const overlay = document.getElementById('report-overlay');
            const titleEl = document.getElementById('report-modal-title');
            const descEl = document.getElementById('report-desc');
            const noteEl = document.getElementById('report-note');
            const deptWrap = document.getElementById('report-dept-wrap');
            const deptSelect = document.getElementById('report-dept-select');
            const tableWrap = document.getElementById('report-score-table-wrap');
            const uni = getMergedUniversityData(selectedUniversityName);
            const deptNames = Object.keys(uni);

            descEl.classList.add('hidden');
            noteEl.classList.add('hidden');
            noteEl.textContent = '';
            tableWrap.classList.add('hidden');
            tableWrap.innerHTML = '';

            if (reportType === 'compare') {
                deptWrap.classList.add('hidden');
                titleEl.textContent = selectedUniversityName + ' â€” åŒä¸€ç§‘ç›®ä¸åŒå­¦éƒ¨çš„åˆ†æ•°è¦æ±‚';
                descEl.textContent = 'é€‰ä¸€ä¸ªç§‘ç›®ï¼Œçœ‹è¯¥æ ¡å„å­¦éƒ¨åœ¨è¿™ä¸€ç§‘ä¸Šçš„åˆ†æ•°åˆ†å¸ƒï¼ˆæœ€å°ã€25%ã€ä¸­å¤®å€¼ã€75%ï¼‰ï¼Œæ–¹ä¾¿æ¨ªå‘æ¯”è¾ƒä¸åŒå­¦éƒ¨å¯¹åŒä¸€ç§‘ç›®çš„è¦æ±‚ã€‚';
                descEl.classList.remove('hidden');
                noteEl.textContent = 'ä¸Šå›¾ï¼šå„å­¦éƒ¨è¯¥ç§‘ç›®åˆ†æ•°ä¸­å¤®å€¼å¯¹æ¯”ã€‚ä¸‹è¡¨ï¼šæ¯è¡Œä¸€ä¸ªå­¦éƒ¨ï¼Œåˆ—ä¸ºæœ€å°/25%/ä¸­å¤®å€¼/75%ã€‚';
                noteEl.classList.remove('hidden');
                var subjectSet = new Set();
                deptNames.forEach(function(d) {
                    var subj = uni[d].subjects;
                    if (subj) Object.keys(subj).filter(function(s) { return s !== 'n'; }).forEach(function(s) { subjectSet.add(s); });
                });
                var subjectList = Array.from(subjectSet).sort();
                var subjectSelect = document.getElementById('report-subject-select');
                var subjectWrap = document.getElementById('report-subject-wrap');
                subjectWrap.classList.remove('hidden');
                subjectSelect.innerHTML = '';
                subjectList.forEach(function(s) {
                    var opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    subjectSelect.appendChild(opt);
                });
                function drawCompareChart() {
                    var subjectName = subjectSelect.value;
                    if (!subjectName) return;
                    var rows = [];
                    deptNames.forEach(function(d) {
                        var subj = uni[d].subjects;
                        if (!subj || !subj[subjectName]) return;
                        var o = subj[subjectName];
                        rows.push({ dept: d, min: o.min, p25: o.p25, p50: o.p50, p75: o.p75 });
                    });
                    tableWrap.classList.add('hidden');
                    tableWrap.innerHTML = '';
                    if (rows.length === 0) return;
                    if (reportModalChart) { reportModalChart.destroy(); reportModalChart = null; }
                    reportModalChart = createChartInModal({
                        type: 'bar',
                        data: {
                            labels: rows.map(function(r) { return r.dept; }),
                            datasets: [{
                                label: 'ä¸­å¤®å€¤',
                                data: rows.map(function(r) { return r.p50; }),
                                backgroundColor: 'rgba(201, 162, 39, 0.55)',
                                borderColor: '#8b7355',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(ctx) { return rows[ctx[0].dataIndex].dept; },
                                        label: function(ctx) {
                                            var r = rows[ctx.dataIndex];
                                            return 'ä¸­å¤®å€¤ ' + (r.p50 != null ? r.p50 : 'â€”') + 'ã€€æœ€å° ' + (r.min != null ? r.min : 'â€”') + 'ã€€25% ' + (r.p25 != null ? r.p25 : 'â€”') + 'ã€€75% ' + (r.p75 != null ? r.p75 : 'â€”');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { title: { display: true, text: 'ã‚¹ã‚³ã‚¢ï¼ˆä¸­å¤®å€¤ï¼‰' }, beginAtZero: true, grid: { color: 'rgba(139, 115, 85, 0.12)' } },
                                y: { grid: { display: false }, ticks: { maxRotation: 0 } }
                            }
                        }
                    });
                    var tableHtml = '<p class="report-table-section-title">åŒä¸€ç§‘ç›®ä¸åŒå­¦éƒ¨çš„åˆ†æ•°è¦æ±‚</p>';
                    tableHtml += '<p class="report-table-desc">ä¸‹è¡¨ï¼šåŒä¸€ç§‘ç›®ã€Œ' + subjectName + 'ã€åœ¨å„å­¦éƒ¨çš„åˆ†æ•°åŒºé—´ã€‚æ¯è¡Œä»£è¡¨ä¸€ä¸ªå­¦éƒ¨ï¼Œåˆ—åˆ†åˆ«ä¸ºæœ€å°åˆ†ã€25%åˆ†ä½ã€ä¸­å¤®å€¼ã€75%åˆ†ä½ï¼Œä¾¿äºæ¯”è¾ƒä¸åŒå­¦éƒ¨å¯¹è¯¥ç§‘çš„è¦æ±‚é«˜ä½ã€‚</p>';
                    tableHtml += '<table class="score-table"><thead><tr><th>å­¦éƒ¨</th><th>æœ€å°</th><th>25%</th><th>ä¸­å¤®å€¤</th><th>75%</th></tr></thead><tbody>';
                    rows.forEach(function(r) {
                        tableHtml += '<tr><td>' + r.dept + '</td><td>' + (r.min != null ? r.min : 'â€”') + '</td><td>' + (r.p25 != null ? r.p25 : 'â€”') + '</td><td>' + (r.p50 != null ? r.p50 : 'â€”') + '</td><td>' + (r.p75 != null ? r.p75 : 'â€”') + '</td></tr>';
                    });
                    tableHtml += '</tbody></table>';
                    tableWrap.innerHTML = tableHtml;
                    tableWrap.classList.remove('hidden');
                }
                if (subjectList.length) {
                    subjectSelect.value = subjectList[0];
                    drawCompareChart();
                }
                subjectSelect.onchange = drawCompareChart;
            } else {
                titleEl.textContent = selectedUniversityName + ' â€” åŒä¸€å­¦éƒ¨çš„ä¸åŒç§‘ç›®åˆ†æ•°è¦æ±‚';
                descEl.textContent = 'é€‰ä¸€ä¸ªå­¦éƒ¨ï¼Œçœ‹è¯¥å­¦éƒ¨å„ç§‘ç›®çš„åˆ†æ•°åˆ†å¸ƒï¼ˆæœ€å°ã€25%ã€ä¸­å¤®å€¼ã€75%ï¼‰ï¼Œäº†è§£è¯¥å­¦éƒ¨å¯¹ä¸åŒç§‘ç›®çš„è¦æ±‚ã€‚';
                descEl.classList.remove('hidden');
                noteEl.textContent = 'ä¸Šå›¾ï¼šè¯¥å­¦éƒ¨å„ç§‘ç›®åˆ†æ•°ä¸­å¤®å€¼å¯¹æ¯”ã€‚ä¸‹è¡¨ï¼šæ¯è¡Œä¸€ä¸ªç§‘ç›®ï¼Œåˆ—ä¸ºæœ€å°/25%/ä¸­å¤®å€¼/75%ã€‚';
                noteEl.classList.remove('hidden');
                document.getElementById('report-subject-wrap').classList.add('hidden');
                deptWrap.classList.remove('hidden');
                deptSelect.innerHTML = '';
                deptNames.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });
                function drawScoreChart() {
                    const dept = deptSelect.value;
                    const deptData = uni[dept];
                    const subj = deptData && deptData.subjects;
                    tableWrap.classList.add('hidden');
                    tableWrap.innerHTML = '';
                    if (!subj || !Object.keys(subj).length) return;
                    const subjectNames = Object.keys(subj).filter(s => s !== 'n');
                    const p50V = subjectNames.map(s => subj[s].p50);
                    if (reportModalChart) { reportModalChart.destroy(); reportModalChart = null; }
                    reportModalChart = createChartInModal({
                        type: 'bar',
                        data: {
                            labels: subjectNames,
                            datasets: [{
                                label: 'ä¸­å¤®å€¤ï¼ˆ50ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼‰',
                                data: p50V,
                                backgroundColor: 'rgba(201, 162, 39, 0.5)',
                                borderColor: '#8b7355',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(ctx) { return subjectNames[ctx[0].dataIndex]; },
                                        label: function(ctx) { return 'ä¸­å¤®å€¤: ' + ctx.raw; },
                                        afterLabel: function(ctx) {
                                            const s = subjectNames[ctx.dataIndex];
                                            const o = subj[s];
                                            return 'æœ€å° ' + (o.min != null ? o.min : 'â€”') + 'ã€€25% ' + (o.p25 != null ? o.p25 : 'â€”') + 'ã€€75% ' + (o.p75 != null ? o.p75 : 'â€”');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { title: { display: true, text: 'ã‚¹ã‚³ã‚¢ï¼ˆä¸­å¤®å€¤ï¼‰' }, beginAtZero: true, grid: { color: 'rgba(139, 115, 85, 0.12)' } },
                                y: { grid: { display: false } }
                            }
                        }
                    });
                    var tableHtml = '<p class="report-table-section-title">åŒä¸€å­¦éƒ¨çš„ä¸åŒç§‘ç›®åˆ†æ•°è¦æ±‚</p>';
                    tableHtml += '<p class="report-table-desc">ä¸‹è¡¨ï¼šè¯¥å­¦éƒ¨å„ç§‘ç›®çš„åˆ†æ•°åŒºé—´ã€‚æ¯è¡Œä»£è¡¨ä¸€ä¸ªç§‘ç›®ï¼Œåˆ—åˆ†åˆ«ä¸ºæœ€å°åˆ†ã€25%åˆ†ä½ã€ä¸­å¤®å€¼ã€75%åˆ†ä½ï¼Œä¾¿äºäº†è§£è¯¥å­¦éƒ¨å¯¹å„ç§‘çš„è¦æ±‚é«˜ä½ã€‚</p>';
                    tableHtml += '<table class="score-table"><thead><tr><th>ç§‘ç›®</th><th>æœ€å°</th><th>25%</th><th>ä¸­å¤®å€¤</th><th>75%</th></tr></thead><tbody>';
                    subjectNames.forEach(s => {
                        const o = subj[s];
                        tableHtml += '<tr><td>' + s + '</td><td>' + (o.min != null ? o.min : 'â€”') + '</td><td>' + (o.p25 != null ? o.p25 : 'â€”') + '</td><td>' + (o.p50 != null ? o.p50 : 'â€”') + '</td><td>' + (o.p75 != null ? o.p75 : 'â€”') + '</td></tr>';
                    });
                    tableHtml += '</tbody></table>';
                    tableWrap.innerHTML = tableHtml;
                    tableWrap.classList.remove('hidden');
                }
                if (deptNames.length) {
                    deptSelect.value = deptNames[0];
                    drawScoreChart();
                }
                deptSelect.onchange = drawScoreChart;
            }
            overlay.classList.add('open');
        }

        function closeReport() {
            document.getElementById('report-overlay').classList.remove('open');
            if (reportModalChart) { reportModalChart.destroy(); reportModalChart = null; }
        }

        function onSearchClick() {
            const keyword = document.getElementById('university-search').value.trim();
            const list = searchUniversities(keyword);
            const emptyEl = document.getElementById('admission-empty');
            const resultsEl = document.getElementById('admission-results');
            if (!keyword) {
                resultsEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                emptyEl.innerHTML = '<i class="fas fa-university text-4xl mb-4 opacity-50"></i><p class="font-medium">å¤§å­¦åã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
                return;
            }
            if (list.length === 0) {
                resultsEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                emptyEl.innerHTML = '<i class="fas fa-search text-4xl mb-4 opacity-50"></i><p class="font-medium">è©²å½“ã™ã‚‹å¤§å­¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p><p class="text-sm mt-1">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è©¦ã—ã¦ãã ã•ã„</p>';
                return;
            }
            selectedUniversityName = list.find(n => n === keyword) || list[0];
            document.getElementById('selected-university-name').textContent = selectedUniversityName;
            emptyEl.classList.add('hidden');
            resultsEl.classList.remove('hidden');
        }

        function initAdmissionSection() {
            fetch('data/admission_score_model.json')
                .then(r => r.json())
                .then(data => {
                    admissionModel = { bunka: data.bunka || {}, rika: data.rika || {} };
                })
                .catch(() => {});

            document.getElementById('search-btn').addEventListener('click', onSearchClick);
            document.getElementById('university-search').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); onSearchClick(); }
            });
            document.querySelectorAll('.report-circle').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!selectedUniversityName) return;
                    openReport(this.getAttribute('data-report'));
                });
            });
            document.getElementById('report-close').addEventListener('click', closeReport);
            document.getElementById('report-overlay').addEventListener('click', function(e) {
                if (e.target === this) closeReport();
            });
        }
        initAdmissionSection();

        function buildCharts(rows) {
            const n = rows.length;
            const colors = (arr) => arr.map((_, i) => PALETTE[i % PALETTE.length]);

            const bunriMap = countBy(rows, 'æ–‡ç†');
            const bunriOrder = ['ç†', 'æ–‡', 'æ–‡ç†ä¸é™'];
            const bunriLabels = bunriOrder.filter(l => bunriMap[l]).length ? bunriOrder.filter(l => bunriMap[l]) : Object.keys(bunriMap);
            const bunriData = bunriLabels.map(l => bunriMap[l] || 0);
            createChart('chart-bunri', {
                type: 'doughnut',
                data: { labels: bunriLabels, datasets: [{ data: bunriData, backgroundColor: colors(bunriLabels) }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            const engMap = countBy(rows, 'è‹±è¯­');
            const engLabels = Object.keys(engMap).filter(k => k !== 'æœªå¡«å†™').sort();
            if (engMap['æœªå¡«å†™']) engLabels.push('æœªå¡«å†™');
            createChart('chart-english', {
                type: 'pie',
                data: { labels: engLabels, datasets: [{ data: engLabels.map(l => engMap[l]), backgroundColor: colors(engLabels) }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            const jlptMap = countBy(rows, 'JLPT');
            const jlptLabels = Object.keys(jlptMap).filter(k => k !== 'æœªå¡«å†™').sort();
            if (jlptMap['æœªå¡«å†™']) jlptLabels.push('æœªå¡«å†™');
            createChart('chart-jlpt', {
                type: 'doughnut',
                data: { labels: jlptLabels.length ? jlptLabels : ['ä¸è¦', 'è¦'], datasets: [{ data: jlptLabels.length ? jlptLabels.map(l => jlptMap[l]) : [n, 0], backgroundColor: colors(jlptLabels.length ? jlptLabels : ['ä¸è¦', 'è¦']) }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            const examFlat = rows.flatMap(r => extractExamFormats(r['æ ¡å†…è€ƒå½¢å¼']));
            const examMap = {};
            examFlat.forEach(k => { examMap[k] = (examMap[k] || 0) + 1; });
            const examSorted = Object.entries(examMap).sort((a, b) => b[1] - a[1]).slice(0, 8);
            createChart('chart-exam-format', {
                type: 'bar',
                data: {
                    labels: examSorted.map(([k]) => k.length > 10 ? k.slice(0, 10) + 'â€¦' : k),
                    datasets: [{ label: 'æ•°é‡', data: examSorted.map(([, v]) => v), backgroundColor: PALETTE[0] }]
                },
                options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: {}, y: {} } }
            });

            const combinedMap = countBy(rows, 'ä½µé¡˜');
            const combinedLabels = Object.keys(combinedMap).filter(k => k !== 'æœªå¡«å†™').sort();
            if (combinedMap['æœªå¡«å†™']) combinedLabels.push('æœªå¡«å†™');
            createChart('chart-combined', {
                type: 'doughnut',
                data: { labels: combinedLabels.length ? combinedLabels : ['å¯', 'ä¸å¯'], datasets: [{ data: combinedLabels.length ? combinedLabels.map(l => combinedMap[l]) : [0, n], backgroundColor: colors(combinedLabels.length ? combinedLabels : ['å¯', 'ä¸å¯']) }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            const regionMap = countBy(rows, 'ä½ç½®', extractRegion);
            const regionSorted = Object.entries(regionMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const regionCtx = document.getElementById('chart-region')?.getContext('2d');
            const regionGrad = regionCtx ? (() => {
                const g = regionCtx.createLinearGradient(0, 0, 400, 0);
                g.addColorStop(0, '#cbd5e1');
                g.addColorStop(0.5, '#94a3b8');
                g.addColorStop(1, '#64748b');
                return g;
            })() : PALETTE[1];
            createChart('chart-region', {
                type: 'bar',
                data: {
                    labels: regionSorted.map(([k]) => k),
                    datasets: [{ label: 'å­¦æ ¡æ•°', data: regionSorted.map(([, v]) => v), backgroundColor: regionGrad }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: {}, y: {} } }
            });

            const periodMap = countBy(rows, 'ç¬¬å‡ æœŸ', extractPeriod);
            const periodLabels = Object.keys(periodMap).filter(k => k !== 'æœªå¡«å†™').sort();
            if (periodMap['æœªå¡«å†™']) periodLabels.push('æœªå¡«å†™');
            createChart('chart-period', {
                type: 'doughnut',
                data: { labels: periodLabels.length ? periodLabels : ['å‰æœŸ', 'åæœŸ', 'ä»…ä¸€æœŸ'], datasets: [{ data: periodLabels.length ? periodLabels.map(l => periodMap[l]) : [0, 0, n], backgroundColor: colors(periodLabels.length ? periodLabels : ['å‰æœŸ', 'åæœŸ', 'ä»…ä¸€æœŸ']) }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            const deadlineMap = {};
            rows.forEach(r => {
                const d = r['ç½‘ä¸Šå‡ºæ„¿æˆªæ­¢æ—¶é—´'];
                if (!d) return;
                const m = d.match(/\d{4}-(\d{2})/);
                if (m) { const month = parseInt(m[1], 10); deadlineMap[month + 'æœˆ'] = (deadlineMap[month + 'æœˆ'] || 0) + 1; }
            });
            const months = ['9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ'].filter(m => deadlineMap[m]);
            createChart('chart-deadline', {
                type: 'line',
                data: {
                    labels: months.length ? months : ['9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ'],
                    datasets: [{ label: 'å­¦æ ¡æ•°', data: (months.length ? months : ['9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ']).map(m => deadlineMap[m] || 0), borderColor: '#64748b', backgroundColor: 'rgba(100, 116, 139, 0.12)', fill: true, tension: 0.3 }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: {}, y: {} } }
            });

            const ejuMap = countBy(rows, 'èƒ½ä½¿ç”¨EJU', extractEjuLabel);
            const ejuSorted = Object.entries(ejuMap).sort((a, b) => b[1] - a[1]).slice(0, 6);
            createChart('chart-eju', {
                type: 'bar',
                data: {
                    labels: ejuSorted.map(([k]) => k),
                    datasets: [{ label: 'æ•°é‡', data: ejuSorted.map(([, v]) => v), backgroundColor: PALETTE[3] }]
                },
                options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: {}, y: {} } }
            });
        }

        document.querySelectorAll('.accordion-trigger').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = document.getElementById(btn.dataset.target);
                const isOpen = btn.classList.toggle('open');
                target.style.maxHeight = isOpen ? target.scrollHeight + 'px' : '0';
                btn.setAttribute('aria-expanded', isOpen);
            });
        });

        fetch('å­¦æ ¡æ€»è§ˆ.csv')
            .then(r => r.text())
            .then(text => {
                const rows = parseCSV(text);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('accordions').classList.remove('hidden');
                buildCharts(rows);
            })
            .catch(() => {
                document.getElementById('loading').innerHTML = '<p class="text-sm opacity-70" style="color: var(--text-secondary)">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å­¦æ ¡æ€»è§ˆ.csv ã‚’åŒéšå±¤ã«ç½®ã„ã¦ãã ã•ã„ã€‚</p>';
            });
    </script>
</body>
</html>
