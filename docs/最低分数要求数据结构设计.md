# 最低分数要求数据结构设计

## 📋 一、需求概述

为每个大学/学部添加**硬性最低分数要求**（必要条件），这些要求必须满足才能通过初步审核。这些要求与现有的统计模型（P50参考分数）不同：

- **统计模型（P50）**：基于历史合格数据的统计参考值（中位数），用于计算匹配度
- **最低分数要求**：大学/学部设定的硬性门槛，不满足则难以通过初审

### 示例
- 東京大学文科一類：数学1必须满分（200分）
- 早稲田大学人間科学学部：数学1必须≥150分

---

## 🗂️ 二、数据存储方案

### 方案选择：在 `学部学校一览表.xlsx` 中添加列

**优点**：
- ✅ 与现有学校数据集中管理，便于维护
- ✅ 教师熟悉该Excel文件，易于填写
- ✅ 与学校基本信息在同一处，逻辑清晰
- ✅ 无需创建新文件，减少维护成本

**缺点**：
- ⚠️ 如果大部分学校没有要求，会有很多空列（但Excel支持空值，不影响）

---

## 📊 三、Excel表格设计

### 3.1 新增列名

在 `学部学校一览表.xlsx` 的"学校总览"工作表中，添加以下列：

| 列名 | 说明 | 数据类型 | 示例 |
|------|------|---------|------|
| `最低日语分数` | 日语科目最低要求分数 | 数字（0-450） | 300 |
| `最低数学1分数` | 数学1科目最低要求分数 | 数字（0-200） | 150 |
| `最低数学2分数` | 数学2科目最低要求分数 | 数字（0-200） | 200 |
| `最低综合分数` | 综合科目最低要求分数 | 数字（0-200） | 180 |
| `最低物理分数` | 物理科目最低要求分数 | 数字（0-100） | 80 |
| `最低化学分数` | 化学科目最低要求分数 | 数字（0-100） | 85 |
| `最低生物分数` | 生物科目最低要求分数 | 数字（0-100） | 75 |
| `最低托福分数` | 托福最低要求分数 | 数字（0-120） | 90 |

### 3.2 填写规则

1. **只填写有硬性要求的科目**
   - 如果某个大学/学部对某科目没有硬性最低要求，该列留空即可
   - 例如：如果早稲田大学人間科学学部只要求数学1≥150，其他科目列都留空

2. **分数格式**
   - 直接填写数字，不需要单位（如：150，不是"150分"）
   - 支持小数（如：85.5），但通常为整数

3. **"满分"的处理**
   - 如果要求满分，填写该科目的满分值：
     - 数学1/数学2：200
     - 综合：200
     - 日语：450
     - 物理/化学/生物：100
     - 托福：120

4. **示例填写**

| 大学 | 学部 | 最低数学1分数 | 最低数学2分数 | 最低日语分数 | ... |
|------|------|--------------|--------------|--------------|-----|
| 東京大学 | 文科一類 | 200 | | | ... |
| 早稲田大学 | 人間科学学部 | 150 | | | ... |
| 東京大学 | 理科一類 | | 200 | | ... |

---

## 🔧 四、代码修改方案

### 4.1 修改 `export_school_data.py`

在 `COLUMN_MAP` 中添加新列的映射：

```python
COLUMN_MAP = {
    # ... 现有列 ...
    "最低日语分数": "minJapanese",
    "最低数学1分数": "minMath1",
    "最低数学2分数": "minMath2",
    "最低综合分数": "minComprehensive",
    "最低物理分数": "minPhysics",
    "最低化学分数": "minChemistry",
    "最低生物分数": "minBiology",
    "最低托福分数": "minTOEFL",
}
```

这些字段会被自动导出到 `school-master.json` 和 `学校总览.json`。

### 4.2 修改 `compass_score.html` 匹配算法

在 `matchByScore()` 函数中，**在计算匹配度之前**先检查硬性最低要求：

```javascript
function checkMinimumRequirements(uni, userScores) {
    // 定义科目映射
    const subjectMap = {
        '日语': 'minJapanese',
        '数学1': 'minMath1',
        '数学2': 'minMath2',
        '综合': 'minComprehensive',
        '物理': 'minPhysics',
        '化学': 'minChemistry',
        '生物': 'minBiology',
        '托福': 'minTOEFL'
    };
    
    const requiredSubjects = getRequiredSubjects(uni);
    const failedRequirements = [];
    
    for (const subject of requiredSubjects) {
        const minField = subjectMap[subject];
        if (!minField) continue;
        
        const minScore = parseFloat(uni[minField]);
        if (isNaN(minScore) || minScore <= 0) continue; // 没有最低要求，跳过
        
        const userScore = userScores[subject] || 0;
        if (userScore < minScore) {
            failedRequirements.push({
                subject: subject,
                required: minScore,
                actual: userScore
            });
        }
    }
    
    return {
        passed: failedRequirements.length === 0,
        failedRequirements: failedRequirements
    };
}
```

然后在 `matchByScore()` 中使用：

```javascript
matchedResults = universitiesData.map(uni => {
    // 1. 先检查硬性最低要求
    const minCheck = checkMinimumRequirements(uni, userScores);
    if (!minCheck.passed) {
        return {
            ...uni,
            matchStatus: 'blocked', // 新增状态：被硬性要求阻挡
            scoreEffect: 0,
            blockedReason: `未满足最低要求：${minCheck.failedRequirements.map(f => `${f.subject}≥${f.required}（实际${f.actual}）`).join(', ')}`,
            // ... 其他字段
        };
    }
    
    // 2. 如果通过最低要求检查，继续原有的匹配度计算
    const required = getRequiredSubjects(uni);
    // ... 原有的匹配度计算逻辑 ...
});
```

### 4.3 前端显示

在结果展示中，对于 `matchStatus === 'blocked'` 的学校：
- 显示为"❌ 未满足最低要求"
- 显示具体哪些科目未达标
- 不显示匹配度（因为已被硬性要求阻挡）

---

## 📝 五、实施步骤

### 步骤1：更新Excel文件结构
1. 打开 `学部学校一览表.xlsx`
2. 在"学校总览"工作表中，在现有列后添加8个新列（列名见3.1节）
3. 为有硬性要求的大学/学部填写最低分数

### 步骤2：更新导出脚本
1. 修改 `export_school_data.py`，添加新列的映射
2. 运行 `python3 export_school_data.py` 重新生成JSON文件

### 步骤3：更新前端匹配算法
1. 修改 `compass_score.html`，添加 `checkMinimumRequirements()` 函数
2. 在 `matchByScore()` 中集成最低要求检查
3. 更新结果展示逻辑，显示被阻挡的学校

### 步骤4：测试
1. 使用测试数据验证：
   - 满足最低要求的学校正常显示匹配度
   - 不满足最低要求的学校显示为"未满足最低要求"
   - 没有设置最低要求的学校不受影响

---

## 🔍 六、数据验证

### 6.1 数据完整性检查

在 `export_school_data.py` 中添加验证逻辑：

```python
def validate_minimum_scores(row):
    """验证最低分数要求是否在合理范围内"""
    min_scores = {
        'minJapanese': (0, 450),
        'minMath1': (0, 200),
        'minMath2': (0, 200),
        'minComprehensive': (0, 200),
        'minPhysics': (0, 100),
        'minChemistry': (0, 100),
        'minBiology': (0, 100),
        'minTOEFL': (0, 120),
    }
    
    warnings = []
    for field, (min_val, max_val) in min_scores.items():
        val = row.get(field)
        if val is not None:
            try:
                score = float(val)
                if score < min_val or score > max_val:
                    warnings.append(f"{field}: {score} 超出范围 [{min_val}, {max_val}]")
            except (ValueError, TypeError):
                warnings.append(f"{field}: '{val}' 不是有效数字")
    
    return warnings
```

### 6.2 前端数据验证

在 `compass_score.html` 中，确保解析最低分数时处理异常值：

```javascript
function parseMinScore(value) {
    if (value === null || value === undefined || value === '') return null;
    const num = parseFloat(value);
    return isNaN(num) || num <= 0 ? null : num;
}
```

---

## 📚 七、相关文件清单

需要修改的文件：
1. ✅ `学部学校一览表.xlsx` - 添加新列并填写数据
2. ✅ `export_school_data.py` - 添加列映射
3. ✅ `compass_score.html` - 添加最低要求检查逻辑
4. ✅ `docs/计算模型和数据架构说明.md` - 更新文档说明新功能

生成的文件（自动）：
- `school-master.json` - 包含新的最低分数字段
- `学校总览.json` - 包含新的最低分数字段

---

## ❓ 八、常见问题

### Q1: 如果某个大学对某科目没有最低要求怎么办？
**A**: 该列留空即可。前端代码会检查字段是否存在且有效，空值会被忽略。

### Q2: 最低要求和统计模型（P50）的关系是什么？
**A**: 
- **最低要求**：硬性门槛，必须满足，否则初审难以通过
- **P50参考分数**：统计参考值（中位数），用于计算匹配度（在满足最低要求的前提下）

**匹配流程**：
1. 先检查是否满足最低要求（硬性条件）
2. 如果满足，再计算与P50的匹配度
3. 如果不满足，直接标记为"未满足最低要求"

### Q3: 如果最低要求比P50还高怎么办？
**A**: 这是正常的。最低要求是硬性门槛，P50是统计参考（中位数）。如果最低要求是200，P50是180，说明：
- 必须≥200才能通过初审
- 但历史数据显示，合格的人中约一半的人该科≤180（可能是其他科目很强，或者有其他因素）

### Q4: 可以同时设置多个科目的最低要求吗？
**A**: 可以。每个科目都有独立的列，可以分别设置。例如：数学1≥150，日语≥300，托福≥90。

### Q5: 如果填写错误（如数学1填写了300分，但满分是200）怎么办？
**A**: 建议在 `export_school_data.py` 中添加数据验证（见6.1节），在导出时检查并警告异常值。

---

## 🎯 九、总结

本方案通过在 `学部学校一览表.xlsx` 中添加8个最低分数列，实现了：
- ✅ 集中管理：与学校基本信息在同一文件
- ✅ 易于维护：教师可以直接在Excel中填写
- ✅ 灵活性强：只填写有要求的科目，其他留空
- ✅ 向后兼容：不影响现有功能，没有最低要求的学校不受影响

实施后，系统将能够：
1. 在匹配前先检查硬性最低要求
2. 对不满足最低要求的学校显示明确的阻挡原因
3. 对满足最低要求的学校继续使用原有的匹配度计算

---

*设计日期：2025-02-12*
