# 数据对应关系说明

本文档详细说明系统中所有数据的来源、对应关系和列映射。

## 📁 一、原始数据文件（根目录）

### 1. `学部学校一览表.xlsx`
**用途**：学校基本信息的主数据源

**工作表**：
- `学校总览`：包含所有学校、学部、学科的基本信息

**主要列（Excel列名 → JSON字段名）**：

| Excel列名 | JSON字段名 | 说明 | 示例 |
|-----------|-----------|------|------|
| 大学 | `name` | 大学名称 | 東京大学 |
| 学部 | `department` | 学部名称 | 理科一類 |
| 学科 | `major` | 学科名称（可选） | 数理学科 |
| 位置 | `region` | 地理位置 | 東京都 |
| 文理 | `bunri` | 文理分类 | 文/理 |
| 方式 | `selectionMethod` | 入试方式 | 外国人入試 |
| 第几期 | `period` | 出愿期数 | 只有一期 |
| 併願 | `combined` | 是否可併願 | 不可 |
| 能使用EJU | `ejuPeriod` | EJU可用时期 | 当年6月or11月都可 |
| 需要EJU科目 | `ejuSubjects` | 需要的EJU科目 | 日语, 数学コース2 |
| 英语 | `english` | 是否需要英语 | 要/不要 |
| JLPT | `jlpt` | 是否需要JLPT | 要/不要 |
| 网上出愿开始时间 | `mailStart` | 网上出愿开始时间 | 2025-12-01 00:00:00 |
| 网上出愿截止时间 | `mailEnd` | 网上出愿截止时间 | 2025-12-05 00:00:00 |
| 邮寄开始时间 | `mailStartDate` | 邮寄开始时间 | 2025-12-01 00:00:00 |
| 邮寄截止时间 | `mailEndDate` | 邮寄截止时间 | 2025-12-05 00:00:00 |
| 必着/消印 | `mailEndNote` | 邮寄截止说明 | 必着/消印 |
| 校内考形式 | `examFormat` | 校内考形式 | 小论文, 面试（线下） |
| 校内考时间1 | `examDate` | 校内考时间1 | 2026-02-25 00:00:00 |
| 校内考时间2 | `examDate2` | 校内考时间2 | 2026-03-04 00:00:00 |
| 发榜时间 | `announcementDate` | 发榜时间 | 2026-03-10 00:00:00 |
| 特殊成绩要求 | `specialRequirements` | 特殊成绩要求（格式：科目名:分数） | 数学1:150,日语:300 |

**处理脚本**：`export_school_data.py`

**生成文件**：
- `学校总览.json`（中文文件名）
- `school-master.json`（英文文件名，用于部署）
- `学校总览.csv`

**更新方式**：
```bash
python3 export_school_data.py
```

---

### 2. `合格实绩.xlsx`
**用途**：历史合格实绩数据，用于分析各校各科分数要求

**工作表**：
- `2024文科`：2024年文科合格样本
- `2024理科`：2024年理科合格样本
- `2023`：2023年合格样本（需从列判断文理）
- `2022`：2022年合格样本（需从列判断文理）

**主要列（Excel列名 → 分析字段）**：

| Excel列名（支持别名） | 分析字段 | 说明 | 示例 |
|----------------------|---------|------|------|
| 结果/合否/是否合格 | `结果` | 合格状态（仅分析"合格"样本） | 合格 |
| 大学/学校/大学名 | `大学` | 大学名称 | 東京大学 |
| 学部/学部名 | `学部` | 学部名称 | 理科一類 |
| 文理/文/理 | `文理` | 文理分类 | 文/理 |
| 日语/日本語/日语总分 | `日语` | 日语分数 | 350 |
| 数学1/数学一/数学コース1 | `数学1` | 数学1分数 | 180 |
| 数学2/数学二/数学コース2 | `数学2` | 数学2分数 | 190 |
| 综合/综合科目/文综 | `综合` | 综合科目分数 | 180 |
| 物理 | `物理` | 物理分数 | 85 |
| 化学 | `化学` | 化学分数 | 90 |
| 生物 | `生物` | 生物分数 | 88 |
| 托福/TOEFL/英语 | `托福` | 托福分数 | 95 |

**列名别名支持**：
脚本支持多种列名变体，例如：
- `结果` 列可以是：结果、合否、是否合格、最终合格确定、合格与否、出愿结果、status
- `大学` 列可以是：大学、学校、大学名、报考院校、school、name
- `日语` 列可以是：日语、日本語、日语总分、日语成绩、EJU日语、japanese、jp
- 等等...

**处理逻辑**：
1. **过滤规则**：仅保留"合格"样本，排除：
   - "不合格"
   - "没有出愿"、"未出愿"
   - "不考了"、"放弃"、"取消"
   - "还没考学"、"未知"
   - "否"

2. **年份权重**：
   - 2024年：权重 1.0
   - 2023年：权重 0.8
   - 2022年：权重 0.6

3. **统计方法**：
   - 按（大学、学部、文理）分组
   - 对每组各科目计算加权分位数：
     - `min`：最小值
     - `p25`：25%分位数
     - `p50`：中位数（50%分位数）**← 前端主要使用此值**
     - `p75`：75%分位数
     - `n`：样本数

4. **大学名规范化**：
   - 自动统一繁简体（如：东京大学 → 東京大学）
   - 去除括号变体（如：国際基督教大学(ICU) → 国際基督教大学）
   - 统一日汉异体字

**处理脚本**：`scripts/analyze_admission_scores.py`

**生成文件**：
- `data/admission_score_model.json`

**JSON结构**：
```json
{
  "bunka": {
    "大学名": {
      "学部名": {
        "subjects": {
          "日语": { "min": 350, "p25": 360, "p50": 370, "p75": 380, "n": 10 },
          "数学1": { "min": 150, "p25": 160, "p50": 170, "p75": 180, "n": 10 },
          ...
        },
        "n": 10
      }
    }
  },
  "rika": {
    ...
  },
  "version": "1.0",
  "generatedAt": "2025-02-17T10:30:00"
}
```

**更新方式**：
```bash
python3 scripts/analyze_admission_scores.py
```

---

## 📦 二、生成的数据文件

### 1. `学校总览.json` / `school-master.json`
**来源**：`学部学校一览表.xlsx` → `export_school_data.py`

**结构**：
```json
{
  "data": [
    {
      "name": "東京大学",
      "department": "理科一類",
      "major": null,
      "region": "東京都",
      "bunri": "理",
      "selectionMethod": "外国人入試",
      "period": "只有一期",
      "combined": "不可",
      "ejuPeriod": "当年6月or11月都可",
      "ejuSubjects": "日语, 数学コース2",
      "english": "要",
      "jlpt": "不要",
      "mailStart": "2025-12-01 00:00:00",
      "mailEnd": "2025-12-05 00:00:00",
      "mailStartDate": "2025-12-01 00:00:00",
      "mailEndDate": "2025-12-05 00:00:00",
      "mailEndNote": "必着",
      "examFormat": "小论文, 面试（线下）",
      "examDate": "2026-02-25 00:00:00",
      "examDate2": "2026-03-04 00:00:00",
      "announcementDate": "2026-03-10 00:00:00",
      "specialRequirements": "数学1:150,日语:300"
    },
    ...
  ]
}
```

**用途**：
- 前端搜索功能（`compass_search.html`）
- 学校筛选功能（`compass_filter.html`）
- 出愿计划功能（`compass_application.html`）
- 成绩匹配功能（`compass_score.html`）的回退数据源

---

### 2. `学校总览.csv`
**来源**：`学部学校一览表.xlsx` → `export_school_data.py`

**列顺序**：
```
大学,学部,学科,位置,文理,方式,第几期,併願,能使用EJU,需要EJU科目,英语,JLPT,校内考形式,网上出愿开始时间,网上出愿截止时间,邮寄开始时间,邮寄截止时间,校内考时间1,校内考时间2,发榜时间
```

**用途**：
- CSV格式便于Excel打开查看
- 部分前端功能可能直接读取CSV

---

### 3. `data/admission_score_model.json`
**来源**：`合格实绩.xlsx` → `scripts/analyze_admission_scores.py`

**结构**：
```json
{
  "bunka": {
    "大学名": {
      "学部名": {
        "subjects": {
          "日语": { "min": 350, "p25": 360, "p50": 370, "p75": 380, "n": 10 },
          "数学1": { "min": 150, "p25": 160, "p50": 170, "p75": 180, "n": 10 },
          "数学2": { "min": 180, "p25": 190, "p50": 200, "p75": 210, "n": 8 },
          "综合": { "min": 160, "p25": 170, "p50": 180, "p75": 190, "n": 10 },
          "物理": null,
          "化学": null,
          "生物": null,
          "托福": { "min": 80, "p25": 85, "p50": 90, "p75": 95, "n": 10 }
        },
        "n": 10
      }
    }
  },
  "rika": {
    ...
  },
  "version": "1.0",
  "generatedAt": "2025-02-17T10:30:00"
}
```

**科目键**：
- `日语`：日语成绩
- `数学1`：数学コース1成绩
- `数学2`：数学コース2成绩
- `综合`：综合科目成绩
- `物理`：物理成绩
- `化学`：化学成绩
- `生物`：生物成绩
- `托福`：托福成绩

**统计值说明**：
- `min`：最小值
- `p25`：25%分位数
- `p50`：中位数（**前端主要使用此值作为参考分**）
- `p75`：75%分位数
- `n`：样本数

**用途**：
- 成绩匹配功能（`compass_score.html`）：显示各科参考分数线
- 各大学分数要求页面（`compass_score_guide.html`）：展示各校各科分数要求

**回退机制**：
如果 `admission_score_model.json` 中没有某个学校的数据，前端会回退到 `school-master.json` 中的 `recommendJP` / `recommendEN` 字段（如果存在）。

---

## 🔄 三、数据流程总结

### 数据更新流程

```
┌─────────────────────────┐
│  学部学校一览表.xlsx     │
│  (手动填写/更新)         │
└───────────┬─────────────┘
            │
            │ export_school_data.py
            │
            ▼
    ┌───────────────┐
    │ 学校总览.json  │
    │ school-master │
    │ .json         │
    │ 学校总览.csv   │
    └───────────────┘
            │
            │ 前端读取
            │
            ▼
    ┌───────────────┐
    │ 搜索、筛选、   │
    │ 出愿计划等功能 │
    └───────────────┘

┌─────────────────────────┐
│  合格实绩.xlsx          │
│  (手动填写/更新)         │
└───────────┬─────────────┘
            │
            │ analyze_admission_scores.py
            │
            ▼
    ┌──────────────────────┐
    │ admission_score_     │
    │ model.json           │
    └───────────┬──────────┘
                │
                │ 前端读取
                │
                ▼
        ┌───────────────┐
        │ 成绩匹配、    │
        │ 分数要求展示  │
        └───────────────┘
```

---

## 📋 四、列对应关系速查表

### `学部学校一览表.xlsx` → `学校总览.json`

| Excel列名 | JSON字段 | 数据类型 | 说明 |
|-----------|----------|---------|------|
| 大学 | `name` | string | 大学名称 |
| 学部 | `department` | string | 学部名称 |
| 学科 | `major` | string/null | 学科名称（可选） |
| 位置 | `region` | string | 地理位置 |
| 文理 | `bunri` | string | "文" 或 "理" |
| 方式 | `selectionMethod` | string | 入试方式 |
| 第几期 | `period` | string | 出愿期数 |
| 併願 | `combined` | string | 是否可併願 |
| 能使用EJU | `ejuPeriod` | string | EJU可用时期 |
| 需要EJU科目 | `ejuSubjects` | string | 需要的EJU科目列表 |
| 英语 | `english` | string | "要" 或 "不要" |
| JLPT | `jlpt` | string | "要" 或 "不要" |
| 网上出愿开始时间 | `mailStart` | string | 日期时间字符串 |
| 网上出愿截止时间 | `mailEnd` | string | 日期时间字符串 |
| 邮寄开始时间 | `mailStartDate` | string | 日期时间字符串 |
| 邮寄截止时间 | `mailEndDate` | string | 日期时间字符串 |
| 必着/消印 | `mailEndNote` | string | 邮寄截止说明 |
| 校内考形式 | `examFormat` | string | 校内考形式描述 |
| 校内考时间1 | `examDate` | string | 日期时间字符串 |
| 校内考时间2 | `examDate2` | string | 日期时间字符串 |
| 发榜时间 | `announcementDate` | string | 日期时间字符串 |
| 特殊成绩要求 | `specialRequirements` | string | 格式：科目名:分数,科目名:分数 |

### `合格实绩.xlsx` → `admission_score_model.json`

| Excel列名（支持别名） | 分析字段 | 统计结果 | 说明 |
|----------------------|---------|---------|------|
| 结果/合否/... | `结果` | - | 仅分析"合格"样本 |
| 大学/学校/... | `大学` | 分组键 | 大学名称（会规范化） |
| 学部/学部名 | `学部` | 分组键 | 学部名称 |
| 文理/文/理 | `文理` | 分组键 | "文" 或 "理" |
| 日语/日本語/... | `日语` | min/p25/p50/p75/n | 日语成绩统计 |
| 数学1/数学一/... | `数学1` | min/p25/p50/p75/n | 数学1成绩统计 |
| 数学2/数学二/... | `数学2` | min/p25/p50/p75/n | 数学2成绩统计 |
| 综合/综合科目/... | `综合` | min/p25/p50/p75/n | 综合科目成绩统计 |
| 物理 | `物理` | min/p25/p50/p75/n | 物理成绩统计 |
| 化学 | `化学` | min/p25/p50/p75/n | 化学成绩统计 |
| 生物 | `生物` | min/p25/p50/p75/n | 生物成绩统计 |
| 托福/TOEFL/... | `托福` | min/p25/p50/p75/n | 托福成绩统计 |

---

## 🔧 五、更新数据时的注意事项

### 更新 `学部学校一览表.xlsx` 后：
1. 运行 `python3 export_school_data.py`
2. 检查生成的 JSON 文件是否正确
3. 前端会自动读取新的 JSON 文件

### 更新 `合格实绩.xlsx` 后：
1. 确保 Excel 文件包含以下工作表：
   - `2024文科`（2024年文科数据）
   - `2024理科`（2024年理科数据）
   - `2023`（2023年数据，可从列判断文理）
   - `2022`（2022年数据，可从列判断文理）

2. 确保表头包含必要的列（支持别名）：
   - 结果/合否列
   - 大学/学校列
   - 学部列
   - 文理列（或从表名判断）
   - 各科目列（日语、数学1、数学2、综合、物理、化学、生物、托福）

3. 运行 `python3 scripts/analyze_admission_scores.py`

4. 检查生成的 `data/admission_score_model.json` 是否正确

5. 前端会自动读取新的 JSON 文件

---

## 📝 六、常见问题

### Q: 为什么有两个 JSON 文件（`学校总览.json` 和 `school-master.json`）？
A: `学校总览.json` 是中文文件名，`school-master.json` 是英文文件名。某些部署环境（如 Render）不支持中文文件名，所以同时生成两个文件，内容完全相同。

### Q: 如果 `合格实绩.xlsx` 中没有某个学校的数据怎么办？
A: 前端会回退到 `school-master.json` 中的 `recommendJP` / `recommendEN` 字段（如果存在）。如果没有这些字段，则不会显示该学校的分数要求。

### Q: 列名必须完全匹配吗？
A: 不需要。脚本支持多种别名。例如，"大学"列可以是：大学、学校、大学名、报考院校、school、name 等。详见 `scripts/analyze_admission_scores.py` 中的 `COLUMN_ALIASES` 字典。

### Q: 如何添加新的列？
A: 
1. 在 Excel 文件中添加新列
2. 在 `export_school_data.py` 的 `COLUMN_MAP` 字典中添加映射
3. 运行脚本重新生成 JSON

---

## 📚 七、相关文档

- `data/README.md` - data 目录说明
- `docs/计算模型和数据架构说明.md` - 详细的数据架构说明
- `docs/最低分数要求数据结构设计.md` - 最低分数要求字段设计
- `docs/特殊成绩要求数据结构设计.md` - 特殊成绩要求字段设计
