# 计算模型和数据架构详细说明

## 📊 一、系统架构概述

你的系统采用**混合数据存储架构**：
- **PostgreSQL数据库**：存储用户数据（用户账号、个人学校列表、出愿计划等）
- **JSON文件**：存储学校总览数据和合格实绩分析数据（静态数据，通过API提供）

### 数据库 vs 文件存储的区别

**PostgreSQL数据库（外部数据库）**：
- 用于存储**动态数据**和**用户相关数据**
- 需要数据库服务器运行（可以是本地或云端，如Render.com）
- 数据可以实时增删改查
- 需要连接字符串（DATABASE_URL）来访问
- 存储内容：用户账号、密码、个人学校列表、出愿计划等

**JSON文件（文件存储）**：
- 用于存储**静态数据**和**分析结果**
- 直接读取文件，无需数据库服务器
- 适合不经常变化的数据
- 存储内容：学校总览信息、合格实绩分析结果等

---

## 📈 二、合格实绩分析模型（admission_score_model.json）

### 2.1 数据源

**原始数据**：`合格实绩.xlsx` Excel文件
- 包含2022-2024年的合格实绩数据
- 按年份和文理分表（如"2024文科"、"2024理科"、"2023"、"2022"）
- 每条记录包含：大学名、学部名、文理、各科成绩（日语、数学1、数学2、综合、物理、化学、生物、托福）

**生成脚本**：`scripts/analyze_admission_scores.py`
- 读取Excel文件
- 分析并生成JSON模型文件

**输出文件**：`data/admission_score_model.json`
- 包含所有学校各学部各科目的统计信息

### 2.2 计算流程

#### 步骤1：数据提取和过滤
```
1. 读取Excel各工作表
2. 仅保留"合格"样本（过滤"不合格"、"没有出愿"、"不考了"等）
3. 提取各字段：大学、学部、文理、各科成绩
```

#### 步骤2：分组统计
```
按 (大学名, 学部名, 文理) 分组
例如：
- 東京大学 · 文科一類 · 文
- 早稲田大学 · 政治経済学部 · 文
- 東京大学 · 理科一類 · 理
```

#### 步骤3：年份权重计算

**权重设置**：
- 2024年：权重 = 1.0（最新数据，最重要）
- 2023年：权重 = 0.8
- 2022年：权重 = 0.6（较旧数据，权重较低）

**为什么使用权重？**
- 留考难度和报考人数每年都在变化
- 近年的数据更能反映当前的录取要求
- 不是简单平均，而是"近几年合格的人的成绩更算数"

#### 步骤4：加权分位数统计

对每个科目（如日语），计算以下统计量：

**计算公式**：
```
1. 收集该组所有样本的该科分数和对应年份权重
   例如：[(346, 1.0), (350, 1.0), (340, 0.8), (345, 0.6)]

2. 按分数从小到大排序

3. 计算加权累计权重，找到分位点
   - min：最低分
   - p25：加权25%分位数（25%的权重对应的分数）
   - p50：加权中位数（50%的权重对应的分数）
   - p75：加权75%分位数（75%的权重对应的分数）
   - n：有效样本数
```

**加权分位数算法**（Python实现）：
```python
def weighted_quantile(values_weights, q):
    """values_weights: [(分数, 权重), ...], q: 分位数(0-1)"""
    sorted_vw = sorted(values_weights, key=lambda x: x[0])  # 按分数排序
    total_w = sum(w for _, w in sorted_vw)  # 总权重
    target = total_w * q  # 目标权重值
    cum = 0  # 累计权重
    for v, w in sorted_vw:
        cum += w
        if cum >= target:
            return v
    return sorted_vw[-1][0]
```

#### 步骤5：参考分数选择

**使用p50（中位数）作为参考分数**（如果没有p50则用min）：
- **含义**：过去合格的人里，约一半的人这一科 ≤ 这个分数
- **为什么用p50？**
  - p50（中位数）更符合**普遍大众**的参考水平
  - 达到p50意味着达到合格生的中等水平，比p25门槛更具代表性
  - 适合作为多数人可参考的目标分数

### 2.3 输出数据结构

```json
{
  "bunka": {
    "東京大学": {
      "文科一類": {
        "subjects": {
          "日语": {
            "min": 346.0,
            "p25": 346.0,
            "p50": 346.0,
            "p75": 346.0,
            "n": 1
          },
          "数学1": { ... },
          "综合": { ... },
          "托福": { ... }
        },
        "n": 1
      }
    }
  },
  "rika": {
    "東京大学": {
      "理科一類": { ... }
    }
  },
  "version": "1.0",
  "generatedAt": "2025-02-12T..."
}
```

---

## 🎯 三、成绩匹配算法（compass_score.html）

### 3.1 用户输入

用户输入各科成绩：
- 日语（0-450）
- 数学1（文科，0-200）
- 数学2（理科，0-200）
- 综合科目（文科，0-200）
- 物理/化学/生物（理科，0-100）
- TOEFL（0-120）

### 3.2 匹配流程

#### 步骤1：获取学校所需科目

```javascript
function getRequiredSubjects(uni) {
    // 从学校的 ejuSubjects 字段解析需要的科目
    // 例如："日语+数学1+综合" → ['日语', '数学1', '综合']
    // 如果 englishRequired 包含"要"或"托福"，则添加'托福'
}
```

#### 步骤2：获取参考分数（阈值）

```javascript
function getThreshold(uni, subjectKey) {
    // 优先从 admission_score_model.json 获取
    // 查找路径：admissionScoreModel[bunka/rika][学校名][学部名].subjects[科目].p50
    // 如果没有p50，使用min
    // 如果模型中没有数据，回退到学校的 recommendJP/recommendEN 字段
    // 如果都没有，使用默认值（日语300，托福80）
}
```

#### 步骤3：计算匹配度

**核心公式**：
```javascript
// 对每个需要的科目，计算达成率
达成率 = 用户分数 / 参考分数

// 取所有科目中的最小达成率
minRatio = min(所有科目的达成率)

// 匹配度 = minRatio（限制在0-2之间）
scoreEffect = Math.min(minRatio, 2)
```

**为什么用最小达成率？**
- 采用"短板原理"：最弱的科目决定了整体匹配度
- 即使其他科目很高，只要有一科不达标，匹配度就会降低
- 更符合实际录取情况（通常要求各科都达到一定水平）

#### 步骤4：分类判定

```javascript
if (scoreEffect >= 1.05) {
    status = 'pass';      // ✅ 合格圏：超过参考分数5%以上
} else if (scoreEffect >= 0.95 && scoreEffect < 1.05) {
    status = 'close';    // ⚠️ 接近圏：在参考分数±5%范围内
} else {
    status = 'reach';    // 👀 观望圏：低于参考分数5%以上
}
```

### 3.3 推荐分数计算

**各学校推荐分数的来源**：

1. **优先使用合格实绩模型**（`admission_score_model.json`）
   - 从该学校该学部该文理的p50（中位数）值获取
   - 这是最准确的，基于真实合格数据

2. **回退到学校总览数据**（`school-master.json`）
   - 使用 `recommendJP`（日语推荐分）
   - 使用 `recommendEN`（托福推荐分）
   - 这些是手动维护的参考值

3. **默认值**
   - 日语：300分
   - 托福：80分

**显示逻辑**：
```javascript
recJP = getThreshold(uni, '日语')  // 日语推荐分
recEN = getThreshold(uni, '托福')  // 托福推荐分
jpDiff = userScores.jp - recJP     // 差距
enDiff = userScores.en - recEN     // 差距
```

---

## 📁 四、数据文件说明

### 4.1 数据文件列表

| 文件路径 | 用途 | 数据来源 | 更新方式 |
|---------|------|---------|---------|
| `合格实绩.xlsx` | 原始合格实绩数据 | 手动填写 | 手动更新 |
| `data/admission_score_model.json` | 合格实绩分析结果 | 由脚本生成 | 运行 `python3 scripts/analyze_admission_scores.py` |
| `school-master.json` | 学校总览数据 | 由脚本生成 | 运行 `python3 export_school_data.py` |
| `学校总览.json` | 学校总览数据（中文名） | 同上 | 同上 |

### 4.2 数据调用流程

#### 前端调用（compass_score.html）

```javascript
// 1. 加载合格实绩模型
fetch('data/admission_score_model.json')
    .then(r => r.json())
    .then(data => {
        admissionScoreModel = data;
    });

// 2. 加载学校总览数据
fetch('/api/school-master')
    .then(r => r.json())
    .then(data => {
        universitiesData = data.data;
    });

// 3. 用户输入成绩后，调用匹配函数
matchByScore();  // 计算匹配度并显示结果
```

#### 后端API（server.js）

```javascript
// 提供学校总览数据API
app.get('/api/school-master', (req, res) => {
    const data = fs.readFileSync('school-master.json', 'utf8');
    res.json(JSON.parse(data));
});
```

### 4.3 数据更新流程

**更新合格实绩分析**：
```bash
# 1. 在 合格实绩.xlsx 中添加新的合格数据
# 2. 运行分析脚本
python3 scripts/analyze_admission_scores.py

# 3. 生成 data/admission_score_model.json
# 4. 前端刷新页面即可看到新的参考分数
```

**更新学校总览**：
```bash
# 1. 更新源数据（CSV或Excel）
# 2. 运行导出脚本
python3 export_school_data.py

# 3. 生成 school-master.json
# 4. 重启服务器或刷新前端
```

---

## 🗄️ 五、数据库架构

### 5.1 PostgreSQL数据库用途

**存储内容**：
- 用户账号信息（users表）
- 用户个人学校列表（schools表）
- 出愿计划（plans表）
- 管理员账号（admins表）

**不存储内容**：
- 学校总览数据（使用JSON文件）
- 合格实绩分析数据（使用JSON文件）

### 5.2 数据库连接

**配置方式**：
```bash
# .env 文件
DATABASE_URL=postgres://user:password@host:5432/database_name
```

**连接代码**（db.js）：
```javascript
const { Pool } = require('pg');
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});
```

**为什么使用外部数据库？**
- 用户数据需要持久化存储
- 支持多用户并发访问
- 数据安全性更好（密码加密存储）
- 可以备份和恢复

---

## 🔄 六、完整数据流

```
┌─────────────────┐
│ 合格实绩.xlsx   │  (手动填写)
└────────┬────────┘
         │
         │ python3 scripts/analyze_admission_scores.py
         ▼
┌─────────────────────────┐
│ admission_score_model.json │  (自动生成)
└────────┬──────────────────┘
         │
         │ fetch('data/admission_score_model.json')
         ▼
┌─────────────────┐
│ compass_score.html │  (前端页面)
└────────┬────────┘
         │
         │ matchByScore()
         ▼
┌─────────────────┐
│   匹配结果展示   │
└─────────────────┘

┌─────────────────┐
│ 学校总览.csv    │  (源数据)
└────────┬────────┘
         │
         │ python3 export_school_data.py
         ▼
┌─────────────────┐
│ school-master.json │  (自动生成)
└────────┬────────┘
         │
         │ GET /api/school-master
         ▼
┌─────────────────┐
│ compass_score.html │  (前端页面)
└─────────────────┘

┌─────────────────┐
│ PostgreSQL DB   │  (用户数据)
└────────┬────────┘
         │
         │ /api/schools, /api/plan
         ▼
┌─────────────────┐
│ 用户个人数据     │
└─────────────────┘
```

---

## 📝 七、关键公式总结

### 7.1 加权分位数公式

```
加权分位数（p25/p50/p75）：
1. 收集所有样本：(分数₁, 权重₁), (分数₂, 权重₂), ...
2. 按分数排序
3. 计算累计权重，找到累计权重达到总权重×q 的位置（q=0.25 为 p25，0.5 为 p50，0.75 为 p75）
4. 该位置的分数即为对应分位数。参考分数采用 p50（中位数）。
```

### 7.2 匹配度计算公式

```
对于学校S，用户U：

1. 获取S需要的科目列表：subjects = ['日语', '数学1', '综合', '托福']

2. 对每个科目i：
   达成率ᵢ = U.分数ᵢ / S.参考分数ᵢ

3. 匹配度 = min(达成率₁, 达成率₂, ..., 达成率ₙ)

4. 分类：
   - 匹配度 ≥ 1.05 → 合格圏
   - 0.95 ≤ 匹配度 < 1.05 → 接近圏
   - 匹配度 < 0.95 → 观望圏
```

### 7.3 年份权重公式

```
权重(2024) = 1.0
权重(2023) = 0.8
权重(2022) = 0.6

加权统计时，每个样本的贡献 = 分数 × 权重
```

---

## 🛠️ 八、常见问题

### Q1: 为什么不用数据库存储学校数据？

**A**: 学校总览数据是静态数据，不经常变化，使用JSON文件：
- 更简单，无需数据库查询
- 可以版本控制（Git）
- 部署更方便（直接复制文件）
- 读取速度快（直接读取文件）

### Q2: 什么时候需要更新数据？

**A**: 
- **合格实绩数据**：每有新的合格样本时更新Excel，然后运行分析脚本
- **学校总览数据**：学校信息变化时更新源数据，然后运行导出脚本
- **用户数据**：实时更新（通过API）

### Q3: 如何添加新的科目？

**A**: 
1. 在 `scripts/analyze_admission_scores.py` 的 `SUBJECT_KEYS` 中添加
2. 在 `COLUMN_ALIASES` 中添加列名映射
3. 在前端 `compass_score.html` 的 `SUBJECT_INPUT_SPEC` 中添加输入框配置
4. 重新运行分析脚本

### Q4: 数据库连接失败怎么办？

**A**: 
1. 检查 `.env` 文件中的 `DATABASE_URL` 是否正确
2. 确认数据库服务器是否运行
3. 检查网络连接和防火墙设置
4. 本地开发可以使用SQLite替代（需要修改代码）

---

## 📚 九、相关文件索引

- **分析脚本**：`scripts/analyze_admission_scores.py`
- **匹配算法**：`compass_score.html` (第957-1035行)
- **数据模型**：`data/admission_score_model.json`
- **数据库配置**：`db.js`
- **API路由**：`routes/schools.js`, `server.js`
- **说明页面**：`compass_score_guide.html`

---

*最后更新：2025-02-12*
