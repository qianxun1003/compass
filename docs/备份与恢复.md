# 系统数据备份与恢复

为防范系统被黑、误删或其它原因导致数据丢失，建议**每天自动备份**数据库与关键文件，并在需要时能从备份恢复。

## 一、每日备份

### 1. 使用本仓库提供的备份脚本（推荐）

在服务器或本机执行：

```bash
# 需已设置环境变量 DATABASE_URL
node scripts/backup-db.js
```

脚本会：

- 将数据库中的 `users`、`schools`、`plan_items`、`teacher_students`、`reminders`、`operation_logs` 表导出为 JSON
- 保存到项目目录下的 `backups/db-backup-YYYYMMDDHHMMSS.json`
- 若存在 `学校总览.json`，会同时复制一份到 `backups/学校总览_YYYYMMDDHHMMSS.json`

**每日自动执行（cron 示例）：**

```bash
# 每天凌晨 2 点执行备份（请将 /path/to/ichikawaryuugaku 改为实际项目路径）
0 2 * * * cd /path/to/ichikawaryuugaku && DATABASE_URL="你的连接串" node scripts/backup-db.js
```

在 Render 上可新建一个 **Cron Job**，将上述命令设为每日运行，并把 `DATABASE_URL` 配置为与 Web Service 相同的数据库连接。

### 2. Render 自带数据库备份（若使用 Render PostgreSQL）

- **Free 计划**：无自动备份，需自行用上述脚本或定时任务备份。
- **Paid 计划**：Render 会为 PostgreSQL 提供每日备份，可在 Dashboard → Database → Backups 中查看与恢复。

无论是否使用 Render 备份，都建议同时用 `scripts/backup-db.js` 做一份应用层备份，便于按表恢复或迁移。

## 二、从备份恢复

### 1. 从 `db-backup-*.json` 恢复数据库

备份文件为 JSON，包含各表数据。恢复时需按依赖顺序写回：

1. `users`
2. `schools`、`plan_items`、`teacher_students`、`reminders`、`operation_logs`

可使用一次性脚本或手动执行 SQL：读取 JSON，按表逐条 `INSERT`（注意主键/序列）。若需，可在此基础上编写 `scripts/restore-db.js`，从指定备份文件读入并写回数据库。

### 2. 恢复「学校总览」文件

若备份了 `backups/学校总览_*.json`：

- 将选中的备份文件复制为项目根目录下的 `学校总览.json`
- 重启应用后，学校总览相关功能会使用恢复后的数据

### 3. Render 上从数据库备份恢复

若使用 Render 的数据库备份：

- 在 Dashboard 中选择对应备份，使用 “Restore” 将数据库恢复到该时间点
- 恢复完成后，应用会使用恢复后的数据库自动运行

## 三、安全建议

- 备份文件建议存放在与生产环境隔离的存储（如另一台服务器、对象存储），并设置访问权限。
- 定期检查备份是否每日成功生成（如查看 `backups/` 目录或 cron 日志）。
- 操作日志（`operation_logs`）已包含在备份中，便于事后审计与排查问题。
