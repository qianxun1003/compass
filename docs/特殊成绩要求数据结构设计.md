# 特殊成绩要求数据结构设计

## 📋 一、需求概述

每个大学/学部可能有各自的**特殊成绩要求**（硬性条件），这些要求必须满足才能通过初步审核。这些要求：
- 不是所有大学都有
- 每个大学的要求可能不同（有些要求"数学满分"，有些要求"数学≥150"）
- 需要灵活存储，不能为每个科目都添加固定列

### 示例
- 東京大学文科一類：数学1必须满分（200分）
- 早稲田大学人間科学学部：数学1必须≥150分
- 其他大部分大学：没有特殊要求

---

## 🗂️ 二、数据存储方案

### 方案选择：在 `学部学校一览表.xlsx` 中添加**一个**"特殊成绩要求"列

**优点**：
- ✅ 灵活性强：可以存储任何格式的要求
- ✅ 易于维护：教师只需填写一个字段
- ✅ 不占用过多列：只有有要求的学校才填写
- ✅ 与现有学校数据集中管理

---

## 📊 三、Excel表格设计

### 3.1 新增列名

在 `学部学校一览表.xlsx` 的"学校总览"工作表中，添加**一个**新列：

| 列名 | 说明 | 数据类型 | 示例 |
|------|------|---------|------|
| `特殊成绩要求` | 该大学/学部的硬性成绩要求 | 文本 | 见下方格式说明 |

### 3.2 填写格式（两种方案）

#### 方案A：简单文本格式（推荐，易于填写）

教师可以直接用自然语言填写，例如：
- `数学1必须满分`
- `数学1≥150`
- `数学1≥150，日语≥300`
- `数学1满分，托福≥90`

**优点**：简单直观，教师容易理解
**缺点**：前端需要解析文本，可能不够精确

#### 方案B：结构化格式（更精确，但需要规范）

使用标准化的格式，例如：
- `数学1:200` （表示数学1必须满分200）
- `数学1:150` （表示数学1必须≥150）
- `数学1:150,日语:300` （多个要求用逗号分隔）
- `数学1:200,托福:90` （不同科目用逗号分隔）

**优点**：易于程序解析，格式统一
**缺点**：需要教师学习格式规范

#### 方案C：JSON格式（最灵活，但复杂）

使用JSON格式存储：
```json
{"数学1": {"min": 150}, "日语": {"min": 300}}
```

**优点**：最灵活，可以存储复杂条件
**缺点**：教师填写困难，容易出错

---

## 🔧 四、推荐方案：结构化文本格式

### 4.1 格式规范

**基本格式**：`科目名:最低分数`，多个要求用逗号分隔

**科目名映射**：
- `日语` → 日语科目
- `数学1` → 数学コース1
- `数学2` → 数学コース2
- `综合` → 综合科目
- `物理` → 物理
- `化学` → 化学
- `生物` → 生物
- `托福` → TOEFL

**示例**：
| 大学 | 学部 | 特殊成绩要求 |
|------|------|-------------|
| 東京大学 | 文科一類 | `数学1:200` |
| 早稲田大学 | 人間科学学部 | `数学1:150` |
| 某大学 | 某学部 | `数学1:150,日语:300` |
| 其他大学 | 其他学部 | （留空） |

**满分处理**：
- 数学1满分：`数学1:200`
- 数学2满分：`数学2:200`
- 综合满分：`综合:200`
- 日语满分：`日语:450`
- 物理/化学/生物满分：`物理:100` / `化学:100` / `生物:100`
- 托福满分：`托福:120`

### 4.2 填写规则

1. **只填写有特殊要求的大学/学部**
   - 如果没有特殊要求，该列留空即可

2. **格式要求**
   - 科目名必须使用标准名称（见上表）
   - 分数必须是数字
   - 多个要求用逗号分隔，逗号后可以有空格
   - 不区分大小写（但建议使用标准格式）

3. **错误示例**
   - ❌ `数学1必须150分` （格式不规范）
   - ❌ `Math1:150` （科目名错误）
   - ❌ `数学1≥150` （符号不支持）
   - ✅ `数学1:150` （正确格式）

---

## 💻 五、代码实现方案

### 5.1 修改 `export_school_data.py`

在 `COLUMN_MAP` 中添加新列的映射：

```python
COLUMN_MAP = {
    # ... 现有列 ...
    "特殊成绩要求": "specialRequirements",  # 或 "minScoreRequirements"
}
```

### 5.2 修改 `compass_score.html` 匹配算法

添加解析和检查函数：

```javascript
/**
 * 解析特殊成绩要求字符串
 * 格式：数学1:150,日语:300
 * 返回：{ "数学1": 150, "日语": 300 }
 */
function parseSpecialRequirements(requirementStr) {
    if (!requirementStr || !requirementStr.trim()) {
        return {};
    }
    
    const requirements = {};
    const parts = requirementStr.split(',').map(s => s.trim());
    
    for (const part of parts) {
        const match = part.match(/^(.+?):(\d+(?:\.\d+)?)$/);
        if (match) {
            const subject = match[1].trim();
            const minScore = parseFloat(match[2]);
            if (!isNaN(minScore) && minScore > 0) {
                requirements[subject] = minScore;
            }
        }
    }
    
    return requirements;
}

/**
 * 检查是否满足特殊成绩要求
 */
function checkSpecialRequirements(uni, scoreBunri) {
    const requirementStr = uni.specialRequirements;
    if (!requirementStr) {
        return { passed: true, failedRequirements: [] };
    }
    
    const requirements = parseSpecialRequirements(requirementStr);
    if (Object.keys(requirements).length === 0) {
        return { passed: true, failedRequirements: [] };
    }
    
    // 定义科目到用户分数的映射
    const subjectScoreMap = {
        '日语': scoreBunri['日语'] || userScores.jp || 0,
        '数学1': scoreBunri['数学1'] || userScores.math1 || 0,
        '数学2': scoreBunri['数学2'] || userScores.math2 || 0,
        '综合': scoreBunri['综合'] || userScores.sogo || 0,
        '物理': scoreBunri['物理'] || userScores.physics || 0,
        '化学': scoreBunri['化学'] || userScores.chemistry || 0,
        '生物': scoreBunri['生物'] || userScores.biology || 0,
        '托福': scoreBunri['托福'] || userScores.en || 0,
    };
    
    const failedRequirements = [];
    
    for (const [subject, minScore] of Object.entries(requirements)) {
        const userScore = subjectScoreMap[subject] || 0;
        if (userScore < minScore) {
            failedRequirements.push({
                subject: subject,
                required: minScore,
                actual: userScore
            });
        }
    }
    
    return {
        passed: failedRequirements.length === 0,
        failedRequirements: failedRequirements
    };
}
```

在 `matchByScore()` 中使用：

```javascript
matchedResults = universitiesData.map(uni => {
    // 1. 先检查特殊成绩要求
    const specialCheck = checkSpecialRequirements(uni, scoreBunri);
    if (!specialCheck.passed) {
        const blockedReason = specialCheck.failedRequirements.map(f => 
            `${f.subject}≥${f.required}（实际${f.actual}）`
        ).join('，');
        return {
            ...uni,
            matchStatus: 'blocked',
            scoreEffect: 0,
            blockedReason: blockedReason,
            recJP: 0,
            recEN: 0,
            jpDiff: 0,
            enDiff: 0,
            recJPUnknown: true,
            recENUnknown: true
        };
    }
    
    // 2. 如果通过特殊要求检查，继续原有的匹配度计算
    const required = getRequiredSubjects(uni);
    // ... 原有的匹配度计算逻辑 ...
});
```

---

## 📝 六、实施步骤

### 步骤1：更新Excel文件结构
1. 打开 `学部学校一览表.xlsx`
2. 在"学校总览"工作表中，添加一个新列：`特殊成绩要求`
3. 为有特殊要求的大学/学部填写要求（使用格式：`科目名:分数`）

### 步骤2：更新导出脚本
1. 修改 `export_school_data.py`，添加 `"特殊成绩要求": "specialRequirements"` 映射
2. 运行 `python3 export_school_data.py` 重新生成JSON文件

### 步骤3：更新前端匹配算法
1. 修改 `compass_score.html`，添加 `parseSpecialRequirements()` 和 `checkSpecialRequirements()` 函数
2. 在 `matchByScore()` 中集成特殊要求检查
3. 更新结果展示逻辑，显示被阻挡的学校

### 步骤4：测试
1. 使用测试数据验证：
   - 满足特殊要求的学校正常显示匹配度
   - 不满足特殊要求的学校显示为"未满足最低要求"
   - 没有设置特殊要求的学校不受影响

---

## 🔍 七、数据验证

### 7.1 格式验证

在 `export_school_data.py` 中可以添加格式验证：

```python
def validate_special_requirements(value):
    """验证特殊成绩要求格式"""
    if pd.isna(value) or not str(value).strip():
        return True, None  # 空值有效
    
    import re
    pattern = r'^[^:,]+:\d+(?:\.\d+)?(?:,\s*[^:,]+:\d+(?:\.\d+)?)*$'
    if re.match(pattern, str(value)):
        return True, None
    else:
        return False, f"格式错误，应为：科目名:分数，多个要求用逗号分隔"
```

### 7.2 前端解析容错

前端解析时应该容错：
- 如果格式不正确，忽略该要求（不阻挡）
- 记录警告信息，方便调试

---

## ❓ 八、常见问题

### Q1: 如果格式填写错误怎么办？
**A**: 前端会尝试解析，如果解析失败，会忽略该要求（不会阻挡用户）。建议在Excel中添加数据验证规则，或者在导出脚本中添加格式检查。

### Q2: 可以支持更复杂的条件吗（如"数学1≥150或数学2≥180"）？
**A**: 当前设计只支持简单的"≥"条件。如果需要更复杂的逻辑，可以考虑：
- 方案A：使用JSON格式存储复杂条件
- 方案B：扩展文本格式，支持 `数学1:150|数学2:180` 表示"或"关系

### Q3: 如果某个大学有多个特殊要求怎么办？
**A**: 使用逗号分隔多个要求，例如：`数学1:150,日语:300,托福:90`

### Q4: 科目名必须完全匹配吗？
**A**: 是的，必须使用标准科目名（日语、数学1、数学2、综合、物理、化学、生物、托福）。建议在Excel中添加下拉列表或数据验证，限制可选的科目名。

---

## 🎯 九、总结

本方案通过在 `学部学校一览表.xlsx` 中添加**一个**"特殊成绩要求"列，实现了：
- ✅ 灵活性强：可以存储任何大学/学部的特殊要求
- ✅ 易于维护：教师只需填写一个字段
- ✅ 格式统一：使用结构化文本格式，易于解析
- ✅ 向后兼容：不影响现有功能，没有特殊要求的学校留空即可

实施后，系统将能够：
1. 解析每个大学/学部的特殊成绩要求
2. 在匹配前先检查是否满足特殊要求
3. 对不满足特殊要求的学校显示明确的阻挡原因
4. 对满足特殊要求的学校继续使用原有的匹配度计算

---

*设计日期：2025-02-12*
*修订：从多列方案改为单列灵活方案*
