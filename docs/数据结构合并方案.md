# 数据结构合并方案

## 🎯 核心问题

**统一爬取框架的输出数据如何与现有数据结构合并？**

**答案**：✅ **完全可以合并，不会冲突！**

---

## 📊 一、现有数据结构

### 当前Excel结构（`学部学校一览表.xlsx`）

| 列名 | JSON字段名 | 说明 |
|------|-----------|------|
| 大学 | `name` | 大学名称 |
| 学部 | `department` | 学部名称 |
| 学科 | `major` | 学科名称 |
| 位置 | `region` | 地理位置 |
| 文理 | `bunri` | 文理分类 |
| 方式 | `selectionMethod` | 选考方式 |
| 第几期 | `period` | 出愿期数 |
| 併願 | `combined` | 是否可併願 |
| 能使用EJU | `ejuPeriod` | EJU可用时期 |
| 需要EJU科目 | `ejuSubjects` | 需要的EJU科目 |
| 英语 | `english` | 是否需要英语 |
| JLPT | `jlpt` | 是否需要JLPT |
| 网上出愿开始时间 | `mailStart` | 网上出愿开始时间 |
| 网上出愿截止时间 | `mailEnd` | 网上出愿截止时间 |
| 邮寄开始时间 | `mailStartDate` | 邮寄开始时间 |
| 邮寄截止时间 | `mailEndDate` | 邮寄截止时间 |
| 必着/消印 | `mailEndNote` | 邮寄截止说明 |
| 校内考形式 | `examFormat` | 校内考形式 |
| 校内考时间1 | `examDate` | 校内考时间1 |
| 校内考时间2 | `examDate2` | 校内考时间2 |
| 发榜时间 | `announcementDate` | 发榜时间 |
| 特殊成绩要求 | `specialRequirements` | 特殊成绩要求 |

---

## 📦 二、统一爬取框架的输出结构

### 爬取框架输出（`crawled_data/unified_crawl_results/`）

```json
{
  "university": "東京大学",
  "department": "理科一類",
  "基础信息": {
    "学部": "理科一類",
    "学科": null,
    "地理位置": "東京都",
    "文理": "理",
    "status": "found"
  },
  "期数信息": {
    "原始表述": "只有一期",
    "所有可能的表述": ["只有一期", "単独選抜"],
    "status": "found"
  },
  "选考方式": {
    "原始表述": "外国人入試",
    "所有可能的表述": ["外国人入試", "外国人特別選抜"],
    "status": "found"
  },
  "校内考信息": {
    "有无": "有",
    "一次选考": {
      "名称": "一次选考",
      "时间": "2026-02-25",
      "形式": "小论文",
      "status": "found"
    },
    "二次选考": {
      "名称": "二次选考",
      "时间": "2026-03-04",
      "形式": "面试（线下）",
      "status": "found"
    }
  },
  "出愿时间": {
    "网上出愿开始": "2025-12-01",
    "网上出愿截止": "2025-12-05",
    "邮寄开始": "2025-12-01",
    "邮寄截止": "2025-12-05",
    "必着/消印": "必着",
    "status": "found"
  },
  "出愿材料": {
    "材料清单": ["入学志愿书", "成绩证明书", ...],
    "推荐信要求": "需要2封",
    "出愿流程": "1. 网上出愿 2. 邮寄材料 ...",
    "status": "found"
  },
  "成绩要求": {
    "EJU科目": {
      "需要的科目": ["日语", "数学コース2"],
      "推荐分数": {"日语": "350-400", "数学2": "180-200"},
      "status": "found"
    },
    "英语": {
      "是否需要": "要",
      "成绩类型": "TOEFL",
      "推荐分数": "80以上",
      "status": "found"
    },
    "JLPT": {
      "是否需要": "不要",
      "等级要求": null,
      "分数要求": null,
      "status": "found"
    }
  },
  "合格情况": {
    "报录比": {
      "2024": {"报考": 150, "合格": 30, "比例": 0.2}
    },
    "status": "found"
  }
}
```

---

## 🔄 三、合并策略

### 策略1：数据映射和转换（推荐）

**思路**：将爬取的数据映射到现有Excel结构

**步骤**：
1. 读取爬取结果
2. 根据映射规则转换为Excel格式
3. 与现有Excel数据合并
4. 生成更新后的Excel

**映射规则**：

```python
映射规则 = {
    # 基础信息
    "基础信息.学部" → "学部"
    "基础信息.学科" → "学科"
    "基础信息.地理位置" → "位置"
    "基础信息.文理" → "文理"
    
    # 期数和选考方式
    "期数信息.原始表述" → "第几期"（需要标准化）
    "选考方式.原始表述" → "方式"（需要标准化）
    
    # 校内考
    "校内考信息.一次选考.形式" + "校内考信息.二次选考.形式" → "校内考形式"
    "校内考信息.一次选考.时间" → "校内考时间1"
    "校内考信息.二次选考.时间" → "校内考时间2"
    
    # 出愿时间
    "出愿时间.网上出愿开始" → "网上出愿开始时间"
    "出愿时间.网上出愿截止" → "网上出愿截止时间"
    "出愿时间.邮寄开始" → "邮寄开始时间"
    "出愿时间.邮寄截止" → "邮寄截止时间"
    "出愿时间.必着/消印" → "必着/消印"
    
    # EJU和成绩
    "成绩要求.EJU科目.需要的科目" → "需要EJU科目"
    "成绩要求.EJU科目.推荐分数" → "EJU推荐分数"（新字段）
    "成绩要求.英语.是否需要" → "英语"
    "成绩要求.英语.成绩类型" → "英语成绩类型"（新字段）
    "成绩要求.英语.推荐分数" → "英语成绩推荐分数"（新字段）
    "成绩要求.JLPT.是否需要" → "JLPT"
    "成绩要求.JLPT.等级要求" → "JLPT等级"（新字段）
    
    # 新字段（需要添加到Excel）
    "出愿材料.材料清单" → "出愿材料"（新字段）
    "出愿材料.推荐信要求" → "推荐信要求"（新字段）
    "出愿材料.出愿流程" → "出愿流程"（新字段）
    "合格情况.报录比" → "报录比"（新字段）
}
```

### 策略2：扩展Excel结构

**思路**：在现有Excel基础上添加新列

**新增列**：
- `英语成绩类型` → `englishType`
- `英语成绩推荐分数` → `englishScoreRecommend`
- `JLPT等级` → `jlptLevel`
- `JLPT分数要求` → `jlptScoreRequire`
- `EJU推荐分数` → `ejuScoreRecommend`
- `出愿材料` → `applicationMaterials`
- `推荐信要求` → `recommendationLetter`
- `出愿流程` → `applicationProcess`
- `报录比（2024）` → `admissionRatio2024`
- `报录比（2023）` → `admissionRatio2023`

---

## 🛠️ 四、合并工具设计

### 合并脚本：`scripts/merge_crawled_data_to_excel.py`

**功能**：
1. 读取爬取结果（JSON）
2. 读取现有Excel
3. 数据映射和转换
4. 数据合并（智能合并策略）
5. 生成更新后的Excel

**合并策略**：
- **优先使用爬取数据**（更准确、更新）
- **保留现有数据**（如果爬取数据缺失）
- **标记数据来源**（爬取/现有/合并）

---

## 📋 五、具体合并流程

### 流程1：数据映射

```
爬取数据（JSON格式）
    ↓
映射规则
    ↓
Excel格式数据
```

### 流程2：数据合并

```
现有Excel数据
    +
爬取数据（已转换）
    ↓
智能合并
    ├── 如果爬取数据有，使用爬取数据
    ├── 如果爬取数据没有，保留现有数据
    └── 如果两者都有，优先使用爬取数据
    ↓
更新后的Excel
```

### 流程3：数据验证

```
更新后的Excel
    ↓
数据验证
    ├── 检查必需字段
    ├── 检查数据格式
    └── 生成验证报告
    ↓
最终Excel数据
```

---

## ✅ 六、不会冲突的原因

### 1. 数据结构兼容

**现有Excel结构**：
- 是"扁平"结构（一行一条记录）
- 每个字段对应一个列

**爬取框架输出**：
- 是"嵌套"结构（JSON格式）
- 但可以映射到Excel的列

**结论**：✅ 完全兼容，可以转换

### 2. 字段对应关系清晰

**现有字段**：
- 大部分字段在爬取数据中都有对应
- 可以直接映射

**新字段**：
- 爬取数据中的新字段可以添加到Excel
- 不会覆盖现有字段

**结论**：✅ 不会冲突，只会扩展

### 3. 合并策略安全

**策略**：
- 优先使用爬取数据（更准确）
- 保留现有数据（如果爬取数据缺失）
- 自动备份原Excel

**结论**：✅ 安全可靠，不会丢失数据

---

## 🔧 七、实施步骤

### 步骤1：扩展Excel结构

**任务**：
1. 在Excel中添加新列（新字段）
2. 更新 `export_school_data.py` 的 `COLUMN_MAP`
3. 保持向后兼容（现有字段不变）

### 步骤2：编写合并脚本

**任务**：
1. 读取爬取结果
2. 数据映射和转换
3. 智能合并
4. 生成更新后的Excel

### 步骤3：运行合并

**任务**：
1. 运行合并脚本
2. 生成更新后的Excel
3. 验证数据质量

### 步骤4：更新系统

**任务**：
1. 运行 `export_school_data.py`
2. 生成新的JSON文件
3. 前端自动使用新数据

---

## 📝 八、示例：合并前后对比

### 合并前（现有Excel）

| 大学 | 学部 | 第几期 | 方式 | 英语 | JLPT | ... |
|------|------|--------|------|------|------|-----|
| 東京大学 | 理科一類 | 只有一期 | 外国人入試 | 要 | 不要 | ... |

### 爬取数据（JSON）

```json
{
  "university": "東京大学",
  "department": "理科一類",
  "期数信息": {"原始表述": "只有一期"},
  "选考方式": {"原始表述": "外国人入試"},
  "成绩要求": {
    "英语": {"是否需要": "要", "成绩类型": "TOEFL", "推荐分数": "80以上"},
    "JLPT": {"是否需要": "不要"}
  }
}
```

### 合并后（更新后的Excel）

| 大学 | 学部 | 第几期 | 方式 | 英语 | 英语成绩类型 | 英语成绩推荐分数 | JLPT | ... |
|------|------|--------|------|------|-------------|----------------|------|-----|
| 東京大学 | 理科一類 | 只有一期 | 外国人入試 | 要 | TOEFL | 80以上 | 不要 | ... |

**变化**：
- ✅ 保留了所有现有字段
- ✅ 添加了新字段（英语成绩类型、英语成绩推荐分数）
- ✅ 数据更完整、更准确

---

## ✅ 九、总结

### 会冲突吗？

**❌ 不会冲突！**

**原因**：
1. ✅ 数据结构兼容（可以转换）
2. ✅ 字段对应关系清晰（可以映射）
3. ✅ 合并策略安全（不会丢失数据）

### 可以合并吗？

**✅ 完全可以合并！**

**方式**：
1. ✅ 数据映射和转换
2. ✅ 智能合并策略
3. ✅ 扩展Excel结构（添加新字段）

### 优势

**合并后的优势**：
- ✅ 数据更完整（补充了缺失字段）
- ✅ 数据更准确（基于官网数据）
- ✅ 数据更标准化（统一分类）
- ✅ 向后兼容（现有功能不受影响）

---

## 🚀 十、下一步

### 我现在可以：

1. **创建Excel模板**（方便老师填写URL）
2. **编写合并脚本**（将爬取数据合并到Excel）
3. **扩展Excel结构**（添加新字段）

**您希望我现在就创建Excel模板吗？**

这样老师就可以直接在Excel中填写URL，非常方便！
