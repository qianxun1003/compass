# 数据更新操作指南

## 📋 概述

系统中有两类数据需要定期更新：
1. **学校总览数据**（`学校总览.json` / `学校总览.csv`）- 包含所有学校的招生信息
2. **合格实绩数据**（`data/admission_score_model.json`）- 包含各学校各学部的成绩统计模型

---

## 🔄 当前更新方式

### 方式一：学校总览数据更新（✅ 已支持后台操作）

**数据源文件**：`学部学校一览表.xlsx`

**操作步骤**：
1. 登录管理者后台：访问 `/admin/login.html`
2. 进入「数据库更新」页面
3. 准备更新后的 Excel 文件（确保格式与 `学部学校一览表.xlsx` 一致）
4. 点击上传区域或拖拽文件上传
5. 系统会自动：
   - 解析 Excel 文件
   - 生成 `学校总览.json` 和 `学校总览.csv`
   - 备份旧文件到 `backups/` 目录（文件名带时间戳）
   - 记录操作日志

**注意事项**：
- Excel 文件必须包含表头：大学、学部、学科、位置、文理、方式等
- 文件大小限制：20MB
- 上传后立即生效，前端刷新即可看到新数据

---

### 方式二：合格实绩数据更新（⚠️ 需要手动运行脚本）

**数据源文件**：`合格实绩.xlsx`

**当前操作步骤**：
1. 在本地编辑 `合格实绩.xlsx`，添加新的合格数据
2. 确保 Excel 文件包含以下工作表：
   - `2024文科`、`2024理科`（最新年份）
   - `2023`、`2022`（历史数据）
3. 在项目根目录运行 Python 脚本：
   ```bash
   python3 scripts/analyze_admission_scores.py
   ```
4. 脚本会自动：
   - 读取 Excel 文件
   - 分析合格样本（过滤不合格数据）
   - 按年份权重计算统计值（2024权重1.0，2023权重0.8，2022权重0.6）
   - 生成 `data/admission_score_model.json`
5. 将生成的 JSON 文件部署到服务器（如果使用 Git，提交并推送）

**注意事项**：
- 需要本地安装 Python 和依赖：`pip install openpyxl`
- 需要服务器访问权限来上传文件
- 更新后需要重启服务或等待缓存刷新

---

## 🎯 推荐改进方案

### 问题分析

**当前状况**：
- ✅ 学校总览数据：已有后台上传功能，操作简单
- ❌ 合格实绩数据：需要手动运行脚本，操作复杂

**改进建议**：
在管理者后台添加「合格实绩数据更新」功能，与学校总览更新类似。

---

## 🚀 增强后的操作流程（推荐实现）

### 完整的数据更新流程

#### 1. 学校总览数据更新（已有功能）

1. 登录管理者后台：`/admin/login.html`
2. 点击「数据库更新」菜单
3. 在「学校总览更新」区域上传 Excel 文件
4. 等待处理完成，查看更新结果和备份信息

#### 2. 合格实绩数据更新（建议新增）

1. 登录管理者后台：`/admin/login.html`
2. 点击「数据库更新」菜单
3. 在「合格实绩更新」区域上传 Excel 文件
4. 系统自动：
   - 解析 Excel 文件（支持多个工作表：2024文科、2024理科、2023、2022等）
   - 运行分析算法（过滤不合格数据、计算加权统计）
   - 生成 `data/admission_score_model.json`
   - 备份旧文件
   - 记录操作日志
5. 查看更新结果和统计信息

---

## 📝 每次更新的具体操作步骤

### 场景一：年度数据更新（学校总览 + 合格实绩）

**时间**：每年招生季开始前（通常 4-5 月）

**步骤**：

1. **准备数据文件**
   - 更新 `学部学校一览表.xlsx`（包含新一年的招生信息）
   - 更新 `合格实绩.xlsx`（添加新一年的合格样本数据）

2. **更新学校总览数据**
   - 登录后台 → 「数据库更新」
   - 上传更新后的 `学部学校一览表.xlsx`
   - 确认更新成功

3. **更新合格实绩数据**（当前需要手动）
   - 方式 A（当前）：本地运行脚本后上传文件
   - 方式 B（推荐）：后台直接上传 Excel 文件

4. **验证更新**
   - 检查前端页面数据是否更新
   - 检查成绩匹配功能是否正常

---

### 场景二：中途数据修正（仅学校总览）

**时间**：发现数据错误时随时更新

**步骤**：
1. 修正 Excel 文件中的错误数据
2. 登录后台 → 「数据库更新」
3. 上传修正后的文件
4. 系统自动备份旧版本，可随时回退

---

## ⚠️ 重要提醒

### 数据备份

- ✅ **学校总览数据**：系统自动备份到 `backups/` 目录
- ⚠️ **合格实绩数据**：当前需要手动备份，建议增强后台功能后也自动备份

### 数据格式要求

**学校总览 Excel 必须包含的列**：
- 大学、学部、学科、位置、文理、方式、第几期、併願
- 能使用EJU、需要EJU科目、英语、JLPT
- 网上出愿开始时间、网上出愿截止时间
- 邮寄开始时间、邮寄截止时间、必着/消印
- 校内考形式、校内考时间1、校内考时间2、发榜时间

**合格实绩 Excel 必须包含的工作表**：
- `2024文科`、`2024理科`（最新年份）
- `2023`、`2022`（历史数据，可选）

**合格实绩 Excel 必须包含的列**：
- 结果（合否）、大学、学部、文理
- 日语、数学1、数学2、综合、物理、化学、生物、托福

---

## 🔧 技术实现建议

### 需要增强的功能

1. **合格实绩数据上传功能**
   - 在后台添加新的上传区域
   - 后端实现 Excel 解析和统计分析（复用 Python 脚本逻辑，或用 Node.js 重写）
   - 自动备份旧文件
   - 显示更新统计信息（样本数、学校数等）

2. **数据版本管理**
   - 显示所有备份版本
   - 支持版本回退功能
   - 显示每次更新的操作人和时间

3. **数据验证**
   - 上传前检查文件格式
   - 验证数据完整性
   - 显示数据统计预览

---

## 📞 遇到问题怎么办？

### 常见问题

1. **上传失败**
   - 检查文件格式是否为 `.xlsx` 或 `.xls`
   - 检查文件大小是否超过 20MB
   - 检查文件是否包含必需的表头

2. **数据未更新**
   - 清除浏览器缓存
   - 检查服务器日志
   - 确认文件已成功上传

3. **需要回退到旧版本**
   - 查看 `backups/` 目录中的备份文件
   - 手动恢复备份文件（或使用版本回退功能）

---

## 📅 更新频率建议

- **学校总览数据**：每年更新 1-2 次（招生季开始前、中途修正）
- **合格实绩数据**：每年更新 1 次（新一年合格结果出来后）

---

*最后更新：2025-02-12*
