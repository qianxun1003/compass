# 英语成绩和单科匹配综合解决方案

## 📋 一、问题分析

### 1.1 核心问题

1. **单科匹配识别**：
   - 从"特殊成绩要求"中识别"只需要某一科"的情况
   - 当用户选择"只有某科分数"时，智能匹配到这些大学

2. **英语成绩复杂性**：
   - 英语不只是托福，还有雅思、托业等
   - 需要统一换算标准
   - 不是每个大学都需要英语成绩

3. **数据结构设计**：
   - 如何在"特殊成绩要求"中处理英语？
   - 如何区分"需要英语"和"不需要英语"？

---

## 🎯 二、设计目标

1. **统一英语成绩标准**：托福、雅思、托业统一换算为"托福等效分数"
2. **智能单科识别**：自动识别"只需要某一科"的大学
3. **灵活匹配**：用户输入任何英语成绩都能匹配
4. **数据清晰**：明确区分是否需要英语成绩

---

## 🔧 三、解决方案设计

### 方案A：统一换算 + 特殊成绩要求扩展（推荐）

#### 3.1 英语成绩统一换算标准

**核心思想**：所有英语成绩统一换算为"托福等效分数"，用同一把尺子衡量。

**换算表**（基于常见的官方换算关系）：

| 托福 (TOEFL) | 雅思 (IELTS) | 托业 (TOEIC) | 备注 |
|-------------|-------------|-------------|------|
| 120 | 9.0 | 990 | 满分 |
| 110 | 8.5 | 945 | 优秀 |
| 100 | 7.5 | 850 | 良好 |
| 90 | 7.0 | 785 | 中等 |
| 80 | 6.5 | 730 | 及格 |
| 70 | 6.0 | 650 | 基础 |
| 60 | 5.5 | 550 | 最低 |

**换算公式**（线性插值）：

```javascript
/**
 * 英语成绩统一换算为托福等效分数
 * @param {number} score - 原始分数
 * @param {string} type - 成绩类型：'toefl' | 'ielts' | 'toeic'
 * @returns {number} - 托福等效分数（0-120）
 */
function convertEnglishScore(score, type) {
    const conversionTable = {
        // 托福：直接返回
        'toefl': (s) => Math.min(Math.max(s, 0), 120),
        
        // 雅思：转换为托福
        'ielts': (s) => {
            // 雅思分数范围：0-9.0（通常以0.5为间隔）
            // 线性换算：6.0 = 70, 6.5 = 80, 7.0 = 90, 7.5 = 100, 8.0 = 110, 8.5 = 115, 9.0 = 120
            if (s >= 9.0) return 120;
            if (s >= 8.5) return 115;
            if (s >= 8.0) return 110;
            if (s >= 7.5) return 100;
            if (s >= 7.0) return 90;
            if (s >= 6.5) return 80;
            if (s >= 6.0) return 70;
            if (s >= 5.5) return 60;
            if (s >= 5.0) return 50;
            // 线性插值
            return Math.round(50 + (s - 5.0) * 20);
        },
        
        // 托业：转换为托福
        'toeic': (s) => {
            // 托业分数范围：0-990
            // 线性换算：550 = 60, 650 = 70, 730 = 80, 785 = 90, 850 = 100, 945 = 110, 990 = 120
            if (s >= 990) return 120;
            if (s >= 945) return 110;
            if (s >= 850) return 100;
            if (s >= 785) return 90;
            if (s >= 730) return 80;
            if (s >= 650) return 70;
            if (s >= 550) return 60;
            // 线性插值
            return Math.round(60 + (s - 550) * (60 / 400)); // 550-990 映射到 60-120
        }
    };
    
    const converter = conversionTable[type.toLowerCase()];
    if (!converter) {
        console.warn(`未知的英语成绩类型: ${type}`);
        return 0;
    }
    
    return converter(score);
}
```

**使用示例**：
```javascript
// 用户输入：雅思7.0
const toeflEquivalent = convertEnglishScore(7.0, 'ielts');  // 返回 90

// 用户输入：托业850
const toeflEquivalent = convertEnglishScore(850, 'toeic');  // 返回 100

// 用户输入：托福100
const toeflEquivalent = convertEnglishScore(100, 'toefl');  // 返回 100
```

---

#### 3.2 特殊成绩要求扩展格式

**核心思想**：在"特殊成绩要求"中明确英语要求，同时支持识别"只需要某一科"的情况。

**格式设计**：

```
格式1：EJU科目要求
科目名:最低分数

格式2：英语要求（新增）
英语:最低分数:成绩类型

格式3：组合要求
科目名1:最低分数1,科目名2:最低分数2,英语:最低分数:成绩类型
```

**示例**：

| 大学 | 学部 | 特殊成绩要求 | 说明 |
|------|------|-------------|------|
| 某大学 | 某学部 | `日语:300` | 只需要日语（单科识别） |
| 某大学 | 某学部 | `数学1:150,日语:300` | 需要数学1和日语 |
| 某大学 | 某学部 | `英语:90:托福` | 需要英语，托福≥90分 |
| 某大学 | 某学部 | `英语:7.0:雅思` | 需要英语，雅思≥7.0分 |
| 某大学 | 某学部 | `日语:300,英语:100:托福` | 需要日语和英语（托福≥100） |
| 某大学 | 某学部 | `数学1:150,英语:850:托业` | 需要数学1和英语（托业≥850） |

**解析逻辑**：

```javascript
/**
 * 解析特殊成绩要求
 * @param {string} requirementStr - 格式：'日语:300,英语:90:托福'
 * @returns {Object} - { eju: { '日语': 300 }, english: { minScore: 90, type: 'toefl' } }
 */
function parseSpecialRequirements(requirementStr) {
    if (!requirementStr || !requirementStr.trim()) {
        return { eju: {}, english: null };
    }
    
    const ejuRequirements = {};
    let englishRequirement = null;
    
    const parts = requirementStr.split(',').map(s => s.trim());
    
    for (const part of parts) {
        // 检查是否是英语要求（格式：英语:分数:类型）
        if (part.startsWith('英语:')) {
            const englishParts = part.split(':');
            if (englishParts.length >= 3) {
                const minScore = parseFloat(englishParts[1]);
                const type = englishParts[2].toLowerCase(); // '托福' | '雅思' | '托业'
                
                if (!isNaN(minScore)) {
                    // 统一转换为托福等效分数
                    const toeflEquivalent = convertEnglishScore(minScore, type);
                    englishRequirement = {
                        originalScore: minScore,
                        originalType: type,
                        minToeflEquivalent: toeflEquivalent,
                        type: type
                    };
                }
            }
        } else {
            // EJU科目要求（格式：科目名:分数）
            const [subject, score] = part.split(':').map(s => s.trim());
            if (subject && score) {
                const scoreNum = parseFloat(score);
                if (!isNaN(scoreNum)) {
                    ejuRequirements[subject] = scoreNum;
                }
            }
        }
    }
    
    return {
        eju: ejuRequirements,
        english: englishRequirement
    };
}
```

---

#### 3.3 单科匹配智能识别

**核心思想**：从特殊成绩要求中识别"只需要某一科"的情况，用于智能匹配。

**识别逻辑**：

```javascript
/**
 * 识别单科匹配的大学
 * @param {Object} uni - 大学数据
 * @returns {Object} - { isSingleSubject: boolean, subject: string, minScore: number }
 */
function identifySingleSubjectMatch(uni) {
    const specialReqs = parseSpecialRequirements(uni.specialRequirements || '');
    const ejuReqs = specialReqs.eju;
    
    // 排除英语，只考虑EJU科目
    const ejuSubjects = Object.keys(ejuReqs);
    
    // 如果只有1个EJU科目要求，且没有英语要求，则是单科匹配
    if (ejuSubjects.length === 1 && !specialReqs.english) {
        return {
            isSingleSubject: true,
            subject: ejuSubjects[0],
            minScore: ejuReqs[ejuSubjects[0]],
            hasEnglish: false
        };
    }
    
    // 如果只有1个EJU科目要求 + 英语要求，也是单科匹配（但需要英语）
    if (ejuSubjects.length === 1 && specialReqs.english) {
        return {
            isSingleSubject: true,
            subject: ejuSubjects[0],
            minScore: ejuReqs[ejuSubjects[0]],
            hasEnglish: true,
            englishRequirement: specialReqs.english
        };
    }
    
    return {
        isSingleSubject: false,
        subject: null,
        minScore: null
    };
}
```

**匹配逻辑**：

```javascript
/**
 * 检查用户选择的科目组合是否匹配单科要求的大学
 * @param {string} selectedEjuCategory - 用户选择的EJU科目组合ID
 * @param {Object} uni - 大学数据
 * @returns {boolean} - 是否匹配
 */
function checkSingleSubjectMatch(selectedEjuCategory, uni) {
    const singleSubjectInfo = identifySingleSubjectMatch(uni);
    
    if (!singleSubjectInfo.isSingleSubject) {
        return false; // 不是单科匹配的大学
    }
    
    // 获取用户选择的科目组合对应的科目列表
    const userSubjects = EJU_CATEGORY_SUBJECT_KEYS[selectedEjuCategory] || [];
    const userEjuSubjects = userSubjects.filter(s => s !== '托福'); // 排除英语
    
    // 检查用户选择的科目是否包含大学要求的科目
    return userEjuSubjects.includes(singleSubjectInfo.subject);
}
```

---

#### 3.4 英语成绩匹配逻辑

**核心思想**：用户输入任何类型的英语成绩，统一换算后与大学要求比较。

**匹配流程**：

```javascript
/**
 * 检查用户英语成绩是否满足要求
 * @param {Object} userEnglishScore - 用户英语成绩 { score: number, type: 'toefl'|'ielts'|'toeic' }
 * @param {Object} englishRequirement - 大学英语要求 { minToeflEquivalent: number, type: string }
 * @returns {Object} - { passed: boolean, userToeflEquivalent: number, requiredToeflEquivalent: number }
 */
function checkEnglishRequirement(userEnglishScore, englishRequirement) {
    if (!englishRequirement) {
        // 大学不需要英语成绩
        return { passed: true, userToeflEquivalent: 0, requiredToeflEquivalent: 0 };
    }
    
    if (!userEnglishScore || !userEnglishScore.score) {
        // 用户没有输入英语成绩
        return { 
            passed: false, 
            userToeflEquivalent: 0, 
            requiredToeflEquivalent: englishRequirement.minToeflEquivalent,
            reason: '未输入英语成绩'
        };
    }
    
    // 统一换算为托福等效分数
    const userToeflEquivalent = convertEnglishScore(
        userEnglishScore.score, 
        userEnglishScore.type
    );
    
    const passed = userToeflEquivalent >= englishRequirement.minToeflEquivalent;
    
    return {
        passed: passed,
        userToeflEquivalent: userToeflEquivalent,
        requiredToeflEquivalent: englishRequirement.minToeflEquivalent,
        reason: passed ? '满足要求' : `不满足要求（需要≥${englishRequirement.minToeflEquivalent}托福等效分数）`
    };
}
```

---

### 方案B：分离英语要求字段（备选）

如果觉得在"特殊成绩要求"中混合英语要求太复杂，可以考虑分离：

**数据结构**：

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `特殊成绩要求` | 文本 | EJU科目要求 | `日语:300,数学1:150` |
| `英语成绩要求` | 文本 | 英语要求（新增） | `90:托福` 或 `7.0:雅思` 或 `850:托业` |

**优点**：
- 结构更清晰
- EJU和英语分离，易于理解

**缺点**：
- 需要新增字段
- 数据维护更复杂

---

## 📊 四、完整数据流设计

### 4.1 数据输入阶段

**用户输入**：
```
EJU科目组合：rika-japanese-only（日本語のみ）
日语成绩：350分
英语成绩：雅思7.5分
```

**系统处理**：
1. 识别用户选择的科目组合
2. 将英语成绩统一换算：雅思7.5 → 托福等效100分
3. 匹配大学

### 4.2 大学匹配阶段

**大学A**（只需要日语）：
```
特殊成绩要求：日语:300
英语成绩要求：无

匹配过程：
1. 单科识别：✅ 只需要日语
2. 用户科目匹配：✅ 用户选择了日语
3. 日语成绩检查：350 >= 300 ✅
4. 英语检查：不需要英语 ✅
结果：✅ 匹配成功
```

**大学B**（需要日语+英语）：
```
特殊成绩要求：日语:300,英语:100:托福
英语成绩要求：100:托福（或从特殊成绩要求中解析）

匹配过程：
1. 单科识别：✅ 只需要日语（但需要英语）
2. 用户科目匹配：✅ 用户选择了日语
3. 日语成绩检查：350 >= 300 ✅
4. 英语检查：用户托福等效100 >= 要求100 ✅
结果：✅ 匹配成功
```

**大学C**（需要多科）：
```
特殊成绩要求：日语:300,数学1:150
英语成绩要求：无

匹配过程：
1. 单科识别：❌ 需要多科
2. 用户科目匹配：❌ 用户只选择了日语，没有数学1
结果：❌ 不匹配
```

---

## 🎨 五、用户界面设计

### 5.1 英语成绩输入

**当前设计**：只有"托福"输入框

**改进设计**：支持多种英语成绩类型

```html
<!-- 英语成绩输入区域 -->
<div class="english-score-input">
    <label>英语成绩</label>
    <select id="english-type">
        <option value="toefl">托福 (TOEFL)</option>
        <option value="ielts">雅思 (IELTS)</option>
        <option value="toeic">托业 (TOEIC)</option>
    </select>
    <input type="number" id="english-score" placeholder="输入分数">
    <span class="hint" id="english-hint">托福满分120，雅思满分9.0，托业满分990</span>
</div>
```

**显示逻辑**：
- 根据选择的类型，显示对应的满分和提示
- 输入后自动换算为托福等效分数（显示在界面上，让用户知道）

### 5.2 匹配结果显示

**单科匹配标识**：
```html
<div class="match-badge single-subject">
    <i class="fas fa-star"></i>
    <span>单科匹配</span>
</div>
```

**英语要求显示**：
```html
<div class="english-requirement">
    <i class="fas fa-language"></i>
    <span>英语要求：托福≥100分（或雅思≥7.5，或托业≥850）</span>
</div>
```

---

## 🔄 六、实现步骤

### 步骤1：更新数据格式
- 更新"特殊成绩要求"填写指南，添加英语要求格式
- 或新增"英语成绩要求"字段（如果采用方案B）

### 步骤2：实现换算函数
- 实现 `convertEnglishScore()` 函数
- 添加换算表验证

### 步骤3：更新解析逻辑
- 更新 `parseSpecialRequirements()` 函数，支持英语要求解析
- 实现 `identifySingleSubjectMatch()` 函数

### 步骤4：更新匹配逻辑
- 集成英语成绩匹配
- 集成单科匹配识别

### 步骤5：更新用户界面
- 添加英语成绩类型选择
- 显示换算结果
- 显示单科匹配标识

### 步骤6：测试验证
- 测试各种英语成绩类型的换算
- 测试单科匹配识别
- 测试组合匹配（EJU + 英语）

---

## 💡 七、方案优势

1. **统一标准**：所有英语成绩统一换算，用同一把尺子衡量
2. **灵活输入**：用户输入任何类型的英语成绩都能匹配
3. **智能识别**：自动识别单科匹配的大学
4. **向后兼容**：不影响现有的EJU科目匹配逻辑
5. **数据清晰**：明确区分是否需要英语成绩

---

## ❓ 八、待讨论问题

1. **换算标准**：托福、雅思、托业的换算关系是否准确？是否需要根据实际录取数据调整？
2. **数据格式**：是否在"特殊成绩要求"中混合英语要求？还是分离为独立字段？
3. **单科识别**：是否只识别"只有1个EJU科目"的情况？还是也包括"1个EJU科目+英语"？
4. **显示方式**：是否在界面上显示"托福等效分数"？还是只显示原始分数？
5. **默认值**：如果用户没有输入英语成绩，但大学需要英语，如何处理？

---

## 📝 九、数据填写示例

### 9.1 飞书表格填写示例

| 大学 | 学部 | 特殊成绩要求 | 说明 |
|------|------|-------------|------|
| 某大学A | 某学部A | `日语:300` | 只需要日语，不需要英语 |
| 某大学B | 某学部B | `日语:300,英语:90:托福` | 需要日语和英语（托福≥90） |
| 某大学C | 某学部C | `日语:300,英语:7.0:雅思` | 需要日语和英语（雅思≥7.0） |
| 某大学D | 某学部D | `数学1:150,日语:300,英语:850:托业` | 需要多科+英语（托业≥850） |

### 9.2 特殊情况处理

**情况1：大学不需要英语成绩**
- `特殊成绩要求`：只填写EJU科目要求，不填写英语
- 系统识别：`englishRequirement = null`

**情况2：大学需要英语，但不限制类型**
- `特殊成绩要求`：`英语:90:托福`（使用托福作为基准）
- 系统处理：换算为托福等效分数，用户输入任何类型都能匹配

**情况3：大学明确要求特定英语成绩类型**
- 当前方案：统一换算，不区分类型
- 如果需要区分：可以在"英语成绩要求"字段中标注"仅接受托福"等

---

*最后更新：2025-02-12*
